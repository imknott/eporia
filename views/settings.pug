//- views/settings.pug
extends player_shell

block content
  .content-scroll(data-page="settings")
    h1.page-title Settings
    
    #saveStatus(style="opacity:0; transition:opacity 0.5s; color:var(--primary); font-weight:800; font-size:0.9rem; margin-bottom:10px; height:20px") 
      i.fas.fa-check(style="margin-right:5px")
      span Saved

    .settings-tabs
      button.tab-btn.active(onclick="switchSettingsTab('audio')") Audio
      button.tab-btn(onclick="switchSettingsTab('finance')") Wallet & Fair Trade
      button.tab-btn(onclick="switchSettingsTab('social')") Social & Privacy
      button.tab-btn(onclick="switchSettingsTab('account')") Account

    .settings-container
      
      //- --- TAB 1: AUDIO ---
      .tab-content#tab-audio
        h3.settings-group-title Equalizer
        .eq-container
            .eq-band
                span.eq-label High
                input.eq-slider(type="range" min="-10" max="10" value=(settings.eqHigh || 0) name="eqHigh" oninput="updateEQ()")
            .eq-band
                span.eq-label Mid
                input.eq-slider(type="range" min="-10" max="10" value=(settings.eqMid || 0) name="eqMid" oninput="updateEQ()")
            .eq-band
                span.eq-label Low
                input.eq-slider(type="range" min="-10" max="10" value=(settings.eqLow || 0) name="eqLow" oninput="updateEQ()")
        
        h3.settings-group-title Playback
        
        .setting-row
          .setting-info
            .setting-label Streaming Quality
            .setting-desc Higher quality uses more data.
          .setting-control
            select.setting-select(onchange="updateSetting('audioQuality', this.value)")
              option(value="auto" selected=(settings.audioQuality === 'auto')) Automatic
              option(value="high" selected=(settings.audioQuality === 'high')) High Fidelity (320kbps)
              option(value="saver" selected=(settings.audioQuality === 'saver')) Data Saver

        .setting-row
           .setting-info
            .setting-label Volume Normalization
            .setting-desc Adjust tracks to the same volume.
           .setting-control
            label.toggle-switch
              input(type="checkbox" checked=(settings.normalizeVolume) onchange="updateSetting('normalizeVolume', this.checked)")
              span.slider.round

        .setting-row
          .setting-info
            .setting-label Crossfade
            .setting-desc Overlap songs for smooth transitions.
          .setting-control
            .range-wrapper(style="display:flex; align-items:center; gap:10px")
              input#fadeRange(type="range" min="0" max="12" value=(settings.crossfade || 3) onchange="updateSetting('crossfade', this.value)" oninput="document.getElementById('fadeVal').innerText = this.value + 's'")
              span#fadeVal(style="font-weight:700; width:30px") #{settings.crossfade || 3}s

      //- --- TAB 2: FINANCE ---
      .tab-content#tab-finance(style="display:none")
        .fair-trade-banner
          i.fas.fa-hand-holding-usd
          div
            strong Fair Trade Controls
            p You control where your $#{subscription && subscription.price ? subscription.price : '12.99'} goes.

        h3.settings-group-title Allocation Strategy
        
        .setting-row
          .setting-info
            .setting-label Default Split Method
            .setting-desc If you use "Auto-Allocate", how do we divide the cash?
          .setting-control
            select.setting-select(onchange="updateSetting('allocationMethod', this.value)")
              option(value="even" selected=(settings.allocationMethod === 'even')) Even Split
              option(value="time" selected=(settings.allocationMethod === 'time')) Listen Time (Pro-Rata)
        
        .setting-row
           .setting-info
            .setting-label Unused Funds
            .setting-desc If you don't listen to anyone in a month:
           .setting-control
            select.setting-select(onchange="updateSetting('rolloverPref', this.value)")
              option(value="rollover" selected=(settings.rolloverPref === 'rollover')) Roll over to next month
              option(value="donate" selected=(settings.rolloverPref === 'donate')) Donate to Community Pool

        .setting-row
           .setting-info
            .setting-label Public Support
            .setting-desc Show my username on artist "Top Supporters" lists.
           .setting-control
            label.toggle-switch
              input(type="checkbox" checked=(settings.publicReceipts) onchange="updateSetting('publicReceipts', this.checked)")
              span.slider.round

      //- --- TAB 3: SOCIAL ---
      .tab-content#tab-social(style="display:none")
        h3.settings-group-title Privacy
        
        .setting-row
          .setting-info
            .setting-label Ghost Mode
            .setting-desc Listen without updating history or followers.
          .setting-control
            label.toggle-switch
              input(type="checkbox" checked=(settings.ghostMode) onchange="updateSetting('ghostMode', this.checked)")
              span.slider.round

        .setting-row
          .setting-info
            .setting-label Local Scene Visibility
            .setting-desc Show my public playlists in the Local Feed.
          .setting-control
            label.toggle-switch
              input(type="checkbox" checked=(settings.localVisibility) onchange="updateSetting('localVisibility', this.checked)")
              span.slider.round
        
        .setting-row
          .setting-info
            .setting-label Taste Match
            .setting-desc Allow others to see our compatibility score.
          .setting-control
            label.toggle-switch
              input(type="checkbox" checked=(settings.tasteMatch) onchange="updateSetting('tasteMatch', this.checked)")
              span.slider.round

      //- --- TAB 4: ACCOUNT ---
      .tab-content#tab-account(style="display:none")
        h3.settings-group-title Membership
        .setting-row
          .setting-info
            .setting-label Current Plan
            .setting-desc #{subscription && subscription.plan ? subscription.plan : 'Individual'} Plan
          .setting-control: button.btn-text(type="button") Manage Billing
        
        setting-row
          .setting-info
            .setting-label Email
            //- Ensure ID matches JS
            .setting-desc#settingsEmail #{user ? user.email : 'Loading...'} 
          .setting-control: button.btn-text(type="button") Update

    div(style="height: 100px")

  //- Only UI logic remains here. Data logic is in enhancedPlayer.js
  script.
    function switchSettingsTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.getElementById('tab-' + tabName).style.display = 'block';
        document.querySelectorAll('.settings-tabs .tab-btn').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }