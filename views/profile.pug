extends player_shell

block content
  .content-scroll(data-page="profile" data-view-mode=viewMode data-target-handle=targetHandle)
    - var heroBg = (viewMode === 'private' && currentUser && currentUser.coverURL) ? "background-image: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0.2)), url('" + currentUser.coverURL + "')" : "background-image: linear-gradient(to right, #444, #222)"
    .user-hero-compact#heroBackground(style=heroBg)
        //- Cover Photo Edit Button
        input#coverInput(type="file" accept="image/*" style="display:none")
        label.edit-cover-btn#coverEditBtn(for="coverInput" style="display:none")
            i.fas.fa-camera
            span Edit Cover
        
        .hero-content-row
            .avatar-wrapper-hero
                - var avatarSrc = (viewMode === 'private' && currentUser && currentUser.photoURL) ? currentUser.photoURL : 'https://cdn.eporiamusic.com/assets/default-avatar.jpg'
                img.hero-avatar-small#profileAvatar(src=avatarSrc style="background:#EEE")
                input#avatarInput(type="file" accept="image/*" style="display:none")
                label.mini-camera-btn#avatarEditBtn(for="avatarInput" style="display:none")
                    i.fas.fa-camera

            .hero-text-row
                h1#profileHandle @Loading...
                .meta-row
                    span.role-badge#profileRole MEMBER
                    span.dot â€¢
                    span.join-date#profileJoinDate Joined ...
                .action-row
                    if !isAdminProfile
                       .impact-pill#impactBadgeContainer(style="display:none")
                         i.fas.fa-hand-holding-heart
                         span#impactScore $0.00 Impact
                    
                    if isAdminProfile
                         button.btn-action-sm.primary#adminAskBtn(style="display:none" onclick="window.ui.openQuestionModal()")
                             i.fas.fa-comment-alt
                             span Ask Question

                    button.btn-action-sm.primary#userFollowBtn(style="display:none; background:#88C9A1; border:none;") 
                        i.fas.fa-user-plus(style="margin-right:5px")
                        span Follow

                    //- [FIX] Always render Edit Button, hide by default, let JS reveal it
                    button.btn-pill.outline#editBtn(style="display:none")
                        i.fas.fa-pencil-alt
                        span Edit Profile

                    //- Save/Cancel controls - hidden by default
                    .edit-controls#saveControls(style="display:none")
                        button.btn-action-sm.success#saveProfileBtn 
                            i.fas.fa-check
                            span Save Changes
                        button.btn-action-sm.text#cancelEditBtn Cancel

    //- Profile Tabs
    .profile-tabs
      button.tab-btn.active(onclick="window.switchProfileTab('overview')") Overview
      button.tab-btn(onclick="window.switchProfileTab('stack')") Signature Stack
      button.tab-btn(onclick="window.switchProfileTab('following')") Following
      
      if isAdminProfile || viewMode === 'private'
          button.tab-btn#tabBtnWall(onclick="window.switchProfileTab('wall')" style=isAdminProfile ? "display:block" : "display:none") Community
    
    //- Overview Tab
    .tab-content#tab-overview
      .overview-grid
          .overview-left
              .bio-section
                  h3 About
                  //- Bio Display
                  p.bio-text#profileBio(style="white-space: pre-wrap;") ...
                  
                  //- Bio Input - hidden by default
                  textarea#bioInput(
                      placeholder="Tell us about yourself..."
                      maxlength="500"
                      style="display:none;width:100%;min-height:100px;max-height:300px;padding:12px;border-radius:8px;border:2px solid #444;background:#2a2a2a;color:#fff;font-family:inherit;font-size:0.95rem;line-height:1.5;resize:vertical;box-sizing:border-box;"
                  )
                  
                  .tags-row
                       span.tag #MusicLover
                       span.tag #EarlyAdopter

              .anthem-section
                  .widget-header
                      h3 Anthem
                      button.icon-btn#anthemEditBtn(style="display:none" onclick="window.ui.openAnthemModal()")
                          i.fas.fa-pen
                  
                  .track-row.anthem-card#anthemPlayer(onclick="playAnthem()" data-song-id="" data-song-title="" data-song-artist="" data-song-img="" data-audio-url="" data-duration="0")
                      img.track-img#anthemArt(src="https://cdn.eporiamusic.com/assets/placeholder_art.jpg")
                      .track-info-row
                          span.t-title#anthemTitle --
                          span.t-artist#anthemArtist --
                      i.fas.fa-play(style="margin-left:auto; color:var(--accent); opacity:0.8; font-size:1.4rem")

          .overview-right
              h3.sub-header Top Artists
              .top-artists-grid#topArtistsGrid

    //- Stack Tab
    .tab-content#tab-stack(style="display:none")
       .playlist-header-row(style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px")
            h3(style="margin:0") Signature Stack
            button.btn-action-sm.text(onclick="navigateTo('/player/workbench')" style="font-size:0.9rem") 
                i.fas.fa-plus(style="margin-right:5px")
                span New Crate
       
       .sub-tabs-container(style="display:flex; gap:15px; margin-bottom:20px; border-bottom:1px solid var(--border-color); padding-bottom:10px")
            button.sub-tab-btn.active(onclick="window.switchStackTab('created')" id="subBtnCreated" style="background:none; border:none; color:var(--text-main); font-weight:700; cursor:pointer; opacity:1") Created
            button.sub-tab-btn(onclick="window.switchStackTab('liked')" id="subBtnLiked" style="background:none; border:none; color:var(--text-secondary); font-weight:700; cursor:pointer; opacity:0.6") Liked
       
       #createdCratesView
           .crates-grid#createdCratesGrid
               .empty-state(style="text-align:center; padding:40px; color:#888") Loading...
       
       #likedCratesView(style="display:none")
           .crates-grid#likedCratesGrid
               .empty-state(style="text-align:center; padding:40px; color:#888") Loading...

    //- Following Tab
    .tab-content#tab-following(style="display:none")
        .sub-tabs-container(style="display:flex; gap:15px; margin-bottom:20px; border-bottom:1px solid var(--border-color); padding-bottom:10px")
            button.sub-tab-btn.active(onclick="window.switchSubTab('artists')" id="subBtnArtists" style="background:none; border:none; color:var(--text-main); font-weight:700; cursor:pointer; opacity:1") Artists
            button.sub-tab-btn(onclick="window.switchSubTab('users')" id="subBtnUsers" style="background:none; border:none; color:var(--text-secondary); font-weight:700; cursor:pointer; opacity:0.6") Users
        
        #followingArtistsView
            .top-artists-grid#fullArtistsGrid
                .empty-state(style="text-align:center; padding:40px; color:#888") Loading...

        #followingUsersView(style="display:none")
            .users-list-vertical#fullUsersGrid(style="display:flex; flex-direction:column; gap:10px")
                .empty-state(style="text-align:center; padding:40px; color:#888") No users followed yet.

    //- Wall Tab
    .tab-content#tab-wall(style="display:none")
       h3.sub-header Community Wall
       .wall-feed#wallFeed
          if viewMode === 'private'
               .wall-post.system
                 p Welcome Admin. Community messages will appear here.

    //- MODALS
    #anthemModal.modal-overlay(style="display:none")
      .modal-content(style="max-width:600px")
        .modal-header
            h3 Select Your Anthem
            button.close-modal(onclick="window.ui.closeAnthemModal()"): i.fas.fa-times
        .modal-body
          input#anthemSearchInput.search-bar(type="text" placeholder="Search tracks...")
          #anthemSearchResults.results-list

    #questionModal.modal-overlay(style="display:none")
      .modal-content
        .modal-header
            h3 Ask Question
            button.close-modal(onclick="window.ui.closeQuestionModal()"): i.fas.fa-times
        .modal-body
          textarea#questionInput.modal-input(placeholder="Type your question here...")
          button.btn-action-sm.primary(onclick="window.ui.submitQuestion()" style="width:100%") Send

    #unfollowModal.modal-overlay(style="display:none; z-index:10000")
      .modal-content(style="max-width:320px; text-align:center; padding:30px")
        h3 Unfollow <span id="unfollowTargetName">User</span>?
        .action-row(style="justify-content:center; gap:15px")
            button.btn-action-sm.text(onclick="window.ui.closeUnfollowModal()") Cancel
            button.btn-action-sm(onclick="window.ui.confirmUnfollow()" style="background:var(--danger); color:white; border:none") Unfollow

    #cropModal.modal-overlay(style="display:none; z-index:10000;")
      .crop-modal(style="background: var(--card-bg); max-width: 500px; width: 90%; border-radius: 20px; padding: 30px; box-shadow: var(--shadow-deep);")
        .modal-header(style="margin-bottom: 20px;")
          h3(style="font-weight: 900; font-size: 1.5rem; margin: 0;") Adjust Photo
          p.subtitle(style="color: var(--text-secondary); font-size: 0.9rem; margin: 5px 0 0;") Drag to position and crop.
        
        .crop-area(style="max-height: 400px; aspect-ratio: 1/1; overflow: hidden; background: #000; border-radius: 12px; margin-bottom: 25px;")
          img#imageToCrop(src="" style="max-width: 100%;")
        
        .modal-actions(style="display: flex; gap: 15px;")
          button.btn-back(onclick="window.ui.cancelCrop()" style="flex: 1; padding: 12px; border-radius: 10px; font-weight: 700; cursor: pointer; border: 1px solid var(--border-color); background: none;") Cancel
          button.btn-next(onclick="window.ui.saveCrop()" style="flex: 1; padding: 12px; border-radius: 10px; font-weight: 800; cursor: pointer; border: none; background: var(--primary); color: #000;") Save Photo

    script(src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js")
    link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css")