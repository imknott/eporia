//- views/profile.pug
extends player_shell

block content
  .content-scroll(data-view-mode=viewMode data-target-handle=targetHandle)
    .user-hero-compact#heroBackground(style="background-image: linear-gradient(to right, #444, #222)")
        //- Cover Photo Edit Button (Only visible in edit mode)
        input#coverInput(type="file" accept="image/*" style="display:none")
        label.edit-cover-btn#coverEditBtn(for="coverInput" style="display:none")
            i.fas.fa-camera
            span Edit Cover
        
        .hero-content-row
             .avatar-wrapper-hero
                  img.hero-avatar-small#profileAvatar(src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" style="background:#EEE")
                  input#avatarInput(type="file" accept="image/*" style="display:none")
                  label.mini-camera-btn#avatarEditBtn(for="avatarInput" style="display:none")
                      i.fas.fa-camera

             .hero-text-row
                  h1#profileHandle @Loading...
                  .meta-row
                      span.role-badge#profileRole MEMBER
                      span.dot â€¢
                      span.join-date#profileJoinDate Joined ...
                  .action-row
                      if !isAdminProfile
                         .impact-pill#impactBadgeContainer(style="display:none")
                           i.fas.fa-hand-holding-heart
                           span#impactScore $0.00 Impact
                      
                      if isAdminProfile
                           button.btn-action-sm.primary#adminAskBtn(style="display:none" onclick="openQuestionModal()")
                               i.fas.fa-comment-alt
                               span Ask Question

                      button.btn-action-sm.primary#userFollowBtn(style="display:none; background:#88C9A1; border:none;" onclick="toggleUserFollow()") 
                          i.fas.fa-user-plus(style="margin-right:5px")
                          span Follow

                      button.btn-action-sm.secondary#editBtn(style="display:none" onclick="toggleEditMode()") 
                          i.fas.fa-pen
                          span Edit Profile

                      .edit-controls#saveControls(style="display:none")
                          button.btn-action-sm.success(onclick="saveProfile()") 
                              i.fas.fa-check
                              span Save Changes
                          button.btn-action-sm.text(onclick="toggleEditMode()") Cancel

    //- Profile Tabs
    .profile-tabs
      button.tab-btn.active(onclick="switchProfileTab('overview')") Overview
      button.tab-btn(onclick="switchProfileTab('stack')") Signature Stack
      button.tab-btn(onclick="switchProfileTab('following')") Following
      
      if isAdminProfile || viewMode === 'private'
          button.tab-btn#tabBtnWall(onclick="switchProfileTab('wall')" style=isAdminProfile ? "display:block" : "display:none") Community
    
    //- Overview Tab
    .tab-content#tab-overview
      .overview-grid
          .overview-left
              .bio-section
                  h3 About
                  p.bio-text#profileBio ...
                  .tags-row
                       span.tag #MusicLover
                       span.tag #EarlyAdopter

              .anthem-section
                  .widget-header
                      h3 Anthem
                      button.icon-btn#anthemEditBtn(style="display:none" onclick="openAnthemModal()")
                          i.fas.fa-pen
                  
                  .track-row.anthem-card#anthemPlayer(onclick="playAnthem()" data-song-id="" data-song-title="" data-song-artist="" data-song-img="" data-audio-url="" data-duration="0")
                      img.track-img#anthemArt(src="https://via.placeholder.com/70")
                      .track-info-row
                          span.t-title#anthemTitle --
                          span.t-artist#anthemArtist --
                      i.fas.fa-play(style="margin-left:auto; color:var(--accent); opacity:0.8; font-size:1.4rem")

          .overview-right
              h3.sub-header Top Artists
              .top-artists-grid#topArtistsGrid
                  //- Populated by JS

    //- Stack Tab
    .tab-content#tab-stack(style="display:none")
       .playlist-header-row
            h3 Current Rotation
            button.btn-action-sm.text(style="font-size:0.8rem") + Add to Queue
       .playlist-list#playlistContainer
           .empty-state No tracks added yet.

    //- Following Tab
    .tab-content#tab-following(style="display:none")
        .sub-tabs-container(style="display:flex; gap:15px; margin-bottom:20px; border-bottom:1px solid var(--border-color); padding-bottom:10px")
            button.sub-tab-btn.active(onclick="switchSubTab('artists')" id="subBtnArtists" style="background:none; border:none; color:var(--text-main); font-weight:700; cursor:pointer; opacity:1") Artists
            button.sub-tab-btn(onclick="switchSubTab('users')" id="subBtnUsers" style="background:none; border:none; color:var(--text-secondary); font-weight:700; cursor:pointer; opacity:0.6") Users
        
        #followingArtistsView
            .top-artists-grid#fullArtistsGrid
                .empty-state(style="text-align:center; padding:40px; color:#888") Loading...

        #followingUsersView(style="display:none")
            .users-list-vertical#fullUsersGrid(style="display:flex; flex-direction:column; gap:10px")
                .empty-state(style="text-align:center; padding:40px; color:#888") No users followed yet.

    //- Wall Tab
    .tab-content#tab-wall(style="display:none")
       h3.sub-header Community Wall
       .wall-feed#wallFeed
          if viewMode === 'private'
               .wall-post.system
                 p Welcome Admin. Community messages will appear here.

    //- ANTHEM MODAL (Enhanced)
    #anthemModal.modal-overlay(style="display:none")
      .modal-content(style="max-width:600px")
        .modal-header
            h3 Select Your Anthem
            button.close-modal(onclick="closeAnthemModal()"): i.fas.fa-times
        .modal-body
          p.modal-subtitle(style="margin-bottom:15px; color:var(--text-muted); font-size:0.9rem") Search for a song to set as your profile anthem
          input#anthemSearchInput.search-bar(type="text" placeholder="Search by song title or artist name..." style="width:100%; padding:12px; border:2px solid var(--border); border-radius:10px; font-size:1rem")
          #anthemSearchResults.results-list(style="max-height:400px; overflow-y:auto; margin-top:20px")
            .empty-search-state(style="text-align:center; padding:60px 20px")
              i.fas.fa-search(style="font-size:3rem; opacity:0.2; margin-bottom:15px; color:var(--text-muted)")
              p(style="color:var(--text-muted); font-size:0.95rem") Start typing to search for songs

    //- QUESTION MODAL
    #questionModal.modal-overlay(style="display:none")
      .modal-content
        .modal-header
            h3 Ask Question
            button.close-modal(onclick="closeQuestionModal()"): i.fas.fa-times
        .modal-body
          textarea#questionInput.modal-input(placeholder="Type your question here...")
          button.btn-action-sm.primary(onclick="submitQuestion()" style="width:100%") Send

    //- UNFOLLOW CONFIRMATION MODAL
    #unfollowModal.modal-overlay(style="display:none; z-index:10000")
      .modal-content(style="max-width:320px; text-align:center; padding:30px")
        i.fas.fa-user-minus(style="font-size:3rem; color:var(--danger); margin-bottom:20px; opacity:0.8")
        h3(style="margin-bottom:10px") Unfollow <span id="unfollowTargetName">User</span>?
        p(style="font-size:0.9rem; color:var(--text-secondary); margin-bottom:25px") 
            | Are you sure? They won't be notified.
        
        .action-row(style="justify-content:center; gap:15px")
            button.btn-action-sm.text(onclick="closeUnfollowModal()") Cancel
            button.btn-action-sm(onclick="confirmUnfollow()" style="background:var(--danger); color:white; border:none") Unfollow

    script(type="module" src="/javascripts/userProfile.js")
    script.
      function openQuestionModal() { document.getElementById('questionModal').style.display = 'flex'; }
      function closeQuestionModal() { document.getElementById('questionModal').style.display = 'none'; }
      function submitQuestion() { alert("Question sent! (Demo)"); closeQuestionModal(); }
      function openAnthemModal() { document.getElementById('anthemModal').style.display = 'flex'; }
      function closeAnthemModal() { document.getElementById('anthemModal').style.display = 'none'; }
      
      // Modal Globals
      function closeUnfollowModal() { 
          document.getElementById('unfollowModal').style.display = 'none';
          window.pendingUnfollow = null; 
      }
      function confirmUnfollow() {
          if (window.pendingUnfollow) window.pendingUnfollow();
          closeUnfollowModal();
      }
