//- views/profile.pug
extends player_shell

block content
  .content-scroll(data-view-mode=viewMode data-target-handle=targetHandle)
    //- ... (Hero Section - Keep same) ...
    .user-hero-compact#heroBackground(style="background-image: linear-gradient(to right, #444, #222)")
        //- ... (Copy existing hero) ...
        .hero-content-row
             .avatar-wrapper-hero
                  img.hero-avatar-small#profileAvatar(src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" style="background:#EEE")
                  input#avatarInput(type="file" accept="image/*" style="display:none")
                  label.mini-camera-btn#avatarEditBtn(for="avatarInput" style="display:none")
                      i.fas.fa-camera

             .hero-text-row
                  h1#profileHandle @Loading...
                  .meta-row
                      span.role-badge#profileRole MEMBER
                      span.dot â€¢
                      span.join-date#profileJoinDate Joined ...
                  .action-row
                      if !isAdminProfile
                         .impact-pill#impactBadgeContainer(style="display:none")
                           i.fas.fa-hand-holding-heart
                           span#impactScore $0.00 Impact
                      
                      if isAdminProfile
                           button.btn-action-sm.primary#adminAskBtn(style="display:none" onclick="openQuestionModal()")
                               i.fas.fa-comment-alt
                               span Ask Question

                      button.btn-action-sm.primary#userFollowBtn(style="display:none; background:#88C9A1; border:none;" onclick="toggleUserFollow()") 
                          i.fas.fa-user-plus(style="margin-right:5px")
                          span Follow

                      button.btn-action-sm.secondary#editBtn(style="display:none" onclick="toggleEditMode()") 
                          i.fas.fa-pen
                          span Edit Profile

                      .edit-controls#saveControls(style="display:none")
                          button.btn-action-sm.success(onclick="saveProfile()") Save Changes
                          button.btn-action-sm.text(onclick="toggleEditMode()") Cancel

    //- [FIX] Updated OnClick Event Names
    .profile-tabs
      button.tab-btn.active(onclick="switchProfileTab('overview')") Overview
      button.tab-btn(onclick="switchProfileTab('stack')") Signature Stack
      button.tab-btn(onclick="switchProfileTab('following')") Following
      
      if isAdminProfile || viewMode === 'private'
          button.tab-btn#tabBtnWall(onclick="switchProfileTab('wall')" style=isAdminProfile ? "display:block" : "display:none") Community

    //- ... (Tab Contents - Keep same) ...
    //- ... (Modals & Scripts - Keep same) ...
    .tab-content#tab-overview
      .overview-grid
          .overview-left
              .bio-section
                  h3 About
                  p.bio-text#profileBio ...
                  .tags-row
                       span.tag #MusicLover
                       span.tag #EarlyAdopter

              .anthem-section
                  .widget-header
                      h3 Anthem
                      button.icon-btn#anthemEditBtn(style="display:none" onclick="openAnthemModal()"): i.fas.fa-pen
                  
                  .track-row.anthem-card#anthemPlayer(onclick="playAnthem()" data-song-id="" data-song-title="" data-song-artist="" data-song-img="")
                      img.track-img#anthemArt(src="https://via.placeholder.com/50")
                      .track-info-row
                          span.t-title#anthemTitle --
                          span.t-artist#anthemArtist --
                      i.fas.fa-play(style="margin-left:auto; color:var(--accent); opacity:0.8")

          .overview-right
              h3.sub-header Top Artists
              .top-artists-grid#topArtistsGrid
                  //- Populated by JS

    .tab-content#tab-stack(style="display:none")
       .playlist-header-row
            h3 Current Rotation
            button.btn-action-sm.text(style="font-size:0.8rem") + Add to Queue
       .playlist-list#playlistContainer
           .empty-state No tracks added yet.

    .tab-content#tab-following(style="display:none")
        .sub-tabs-container(style="display:flex; gap:15px; margin-bottom:20px; border-bottom:1px solid var(--border-color); padding-bottom:10px")
            button.sub-tab-btn.active(onclick="switchSubTab('artists')" id="subBtnArtists" style="background:none; border:none; color:var(--text-main); font-weight:700; cursor:pointer; opacity:1") Artists
            button.sub-tab-btn(onclick="switchSubTab('users')" id="subBtnUsers" style="background:none; border:none; color:var(--text-secondary); font-weight:700; cursor:pointer; opacity:0.6") Users
        
        #followingArtistsView
            .top-artists-grid#fullArtistsGrid
                .empty-state(style="text-align:center; padding:40px; color:#888") Loading...

        #followingUsersView(style="display:none")
            .users-list-vertical#fullUsersGrid(style="display:flex; flex-direction:column; gap:10px")
                .empty-state(style="text-align:center; padding:40px; color:#888") No users followed yet.

    .tab-content#tab-wall(style="display:none")
       h3.sub-header Community Wall
       .wall-feed#wallFeed
          if viewMode === 'private'
               .wall-post.system
                 p Welcome Admin. Community messages will appear here.

    //- ... (Modals & Bottom Scripts) ...
    #anthemModal.modal-overlay(style="display:none")
      .modal-content
        .modal-header
            h3 Select Anthem
            button.close-modal(onclick="closeAnthemModal()"): i.fas.fa-times
        .modal-body
          input#anthemSearchInput.search-bar(type="text" placeholder="Search by song or artist...")
          #anthemSearchResults.results-list

    #questionModal.modal-overlay(style="display:none")
      .modal-content
        .modal-header
            h3 Ask Question
            button.close-modal(onclick="closeQuestionModal()"): i.fas.fa-times
        .modal-body
          textarea#questionInput.modal-input(placeholder="Type your question here...")
          button.btn-action-sm.primary(onclick="submitQuestion()" style="width:100%") Send

    script(type="module" src="/javascripts/userProfile.js")
    script.
      function openQuestionModal() { document.getElementById('questionModal').style.display = 'flex'; }
      function closeQuestionModal() { document.getElementById('questionModal').style.display = 'none'; }
      function submitQuestion() { alert("Question sent! (Demo)"); closeQuestionModal(); }
      function openAnthemModal() { document.getElementById('anthemModal').style.display = 'flex'; }
      function closeAnthemModal() { document.getElementById('anthemModal').style.display = 'none'; }