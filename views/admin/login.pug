doctype html
html
  head
    title Admin Login | Eporia
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    link(rel='stylesheet', href='https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap')
    link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css")
    style.
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { 
        font-family: 'Nunito', sans-serif; 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .login-container {
        background: white;
        max-width: 450px;
        width: 100%;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        overflow: hidden;
        animation: slideUp 0.5s ease-out;
      }
      @keyframes slideUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .login-header {
        background: linear-gradient(135deg, #5C4B3D 0%, #88C9A1 100%);
        padding: 40px;
        text-align: center;
        color: white;
      }
      .login-header i {
        font-size: 3rem;
        margin-bottom: 15px;
      }
      .login-header h1 {
        font-size: 1.8rem;
        margin-bottom: 5px;
      }
      .login-header p {
        font-size: 0.9rem;
        opacity: 0.9;
      }
      .login-body {
        padding: 40px;
      }
      .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
      }
      .alert.error {
        background: #FFEBEE;
        color: #C62828;
        border-left: 4px solid #E74C3C;
      }
      .alert.success {
        background: #E8F5E9;
        color: #2E7D32;
        border-left: 4px solid #88C9A1;
      }
      .form-group {
        margin-bottom: 25px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 700;
        color: #333;
        font-size: 0.9rem;
      }
      .form-group input {
        width: 100%;
        padding: 14px;
        border: 2px solid #E0E0E0;
        border-radius: 8px;
        font-size: 1rem;
        font-family: 'Nunito', sans-serif;
        transition: all 0.2s;
      }
      .form-group input:focus {
        outline: none;
        border-color: #88C9A1;
        box-shadow: 0 0 0 3px rgba(136, 201, 161, 0.1);
      }
      .btn-login {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, #88C9A1 0%, #5C4B3D 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        font-family: 'Nunito', sans-serif;
      }
      .btn-login:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(136, 201, 161, 0.3);
      }
      .btn-login:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      .security-note {
        margin-top: 25px;
        padding: 15px;
        background: #F5F5F5;
        border-radius: 8px;
        font-size: 0.85rem;
        color: #666;
        text-align: center;
      }
      .security-note i {
        color: #88C9A1;
        margin-right: 5px;
      }
      .back-link {
        display: block;
        text-align: center;
        margin-top: 20px;
        color: #5C4B3D;
        text-decoration: none;
        font-weight: 600;
      }
      .back-link:hover {
        text-decoration: underline;
      }

  body
    .login-container
      .login-header
        i.fas.fa-shield-alt
        h1 Admin Access
        p Authorized Personnel Only
      
      .login-body
        #alertBox.alert
        
        form#loginForm
          .form-group
            label(for="email") 
              i.fas.fa-envelope(style="margin-right:5px")
              | Email Address
            input#email(type="email" name="email" placeholder="admin@eporiamusic.com" required autocomplete="email")
          
          .form-group
            label(for="password") 
              i.fas.fa-lock(style="margin-right:5px")
              | Password
            input#password(type="password" name="password" placeholder="Enter your password" required autocomplete="current-password")
          
          button.btn-login#btnLogin(type="submit")
            i.fas.fa-sign-in-alt(style="margin-right:8px")
            | Sign In to Admin Panel
        
        .security-note
          i.fas.fa-info-circle
          | For security, you must sign in each time you access the admin panel. Sessions are not persisted.
        
        a.back-link(href="/")
          i.fas.fa-arrow-left(style="margin-right:5px")
          | Back to Home

    script(type="module").
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getAuth, signInWithEmailAndPassword, setPersistence, inMemoryPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
      import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
      
      // Initialize Firebase (use your config)
      const firebaseConfig = {
        apiKey: "#{process.env.FIREBASE_API_KEY}",
        authDomain: "#{process.env.FIREBASE_AUTH_DOMAIN}",
        projectId: "#{process.env.FIREBASE_PROJECT_ID}",
        storageBucket: "#{process.env.FIREBASE_STORAGE_BUCKET}",
        messagingSenderId: "#{process.env.FIREBASE_MESSAGING_SENDER_ID}",
        appId: "#{process.env.FIREBASE_APP_ID}"
      };
      
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      
      // CRITICAL: Set to in-memory persistence so session is never saved
      // This ensures admin must login every time
      setPersistence(auth, inMemoryPersistence)
        .then(() => {
          console.log('In-memory persistence set - no session storage');
        })
        .catch((error) => {
          console.error('Persistence error:', error);
        });
      
      const form = document.getElementById('loginForm');
      const alertBox = document.getElementById('alertBox');
      const btnLogin = document.getElementById('btnLogin');
      
      function showAlert(type, message) {
        alertBox.className = `alert ${type}`;
        alertBox.innerText = message;
        alertBox.style.display = 'block';
        
        setTimeout(() => {
          alertBox.style.display = 'none';
        }, 5000);
      }
      
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        btnLogin.disabled = true;
        btnLogin.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right:8px"></i> Verifying...';
        
        try {
          // 1. Sign in with Firebase Auth
          const userCredential = await signInWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;
          
          // 2. Get user document from Firestore to check role
          const userDocRef = doc(db, 'users', user.uid);
          const userDoc = await getDoc(userDocRef);
          
          if (!userDoc.exists()) {
            throw new Error('User profile not found');
          }
          
          const userData = userDoc.data();
          
          // 3. Check if user has admin role
          if (userData.role !== 'admin') {
            await auth.signOut(); // Sign out non-admin users
            throw new Error('Access denied. Admin privileges required.');
          }
          
          // 4. Get ID token for API calls
          const idToken = await user.getIdToken();
          
          // Store token in sessionStorage (will be cleared when tab/browser closes)
          sessionStorage.setItem('adminToken', idToken);
          sessionStorage.setItem('adminUser', JSON.stringify({
            uid: user.uid,
            email: user.email,
            role: userData.role
          }));
          
          showAlert('success', 'Login successful! Redirecting...');
          
          // 5. Redirect to admin dashboard
          setTimeout(() => {
            window.location.href = '/admin/dashboard';
          }, 1000);
          
        } catch (error) {
          console.error('Login error:', error);
          
          let errorMessage = 'Login failed. Please try again.';
          
          if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
            errorMessage = 'Invalid email or password.';
          } else if (error.code === 'auth/user-not-found') {
            errorMessage = 'No account found with this email.';
          } else if (error.code === 'auth/too-many-requests') {
            errorMessage = 'Too many failed attempts. Please try again later.';
          } else if (error.message.includes('Admin privileges')) {
            errorMessage = error.message;
          }
          
          showAlert('error', errorMessage);
          
          btnLogin.disabled = false;
          btnLogin.innerHTML = '<i class="fas fa-sign-in-alt" style="margin-right:8px"></i> Sign In to Admin Panel';
        }
      });
      
      // Clear any existing session on page load
      sessionStorage.removeItem('adminToken');
      sessionStorage.removeItem('adminUser');
