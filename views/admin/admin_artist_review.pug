doctype html
html
  head
    title Artist Applications | Eporia Admin
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    link(rel='stylesheet', href='https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap')
    link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css")
    style.
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { 
        font-family: 'Nunito', sans-serif;
        background: #F5F5F5;
      }
      .admin-nav {
        background: linear-gradient(135deg, #5C4B3D 0%, #88C9A1 100%);
        color: white;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      .nav-brand { font-size: 1.5rem; font-weight: 800; }
      .nav-links { display: flex; gap: 20px; align-items: center; }
      .btn-logout { padding: 10px 20px; background: rgba(255,255,255,0.2); border: 2px solid white; color: white; border-radius: 8px; cursor: pointer; font-weight: 700; transition: all 0.2s; }
      .btn-logout:hover { background: white; color: #5C4B3D; }
      
      .container { max-width: 1400px; margin: 0 auto; padding: 30px; }
      .page-header { margin-bottom: 30px; }
      .page-header h1 { font-size: 2rem; color: #333; margin-bottom: 5px; }
      
      .review-list { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
      .review-item { padding: 25px; border-bottom: 1px solid #EEE; display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: start; }
      .review-item:last-child { border-bottom: none; }
      
      .handle { color: #88C9A1; font-weight: 700; margin-bottom: 10px; display: block; }
      .meta-item { font-size: 0.85rem; color: #666; margin-bottom: 5px; }
      .meta-item i { color: #88C9A1; margin-right: 8px; width: 16px; }
      
      .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; }
      .btn-approve { background: #88C9A1; color: white; margin-bottom: 10px; }
      .btn-reject { background: #FFF; color: #E74C3C; border: 2px solid #E74C3C; }
      .btn-reject:hover { background: #E74C3C; color: white; }
      
      .empty-state { text-align: center; padding: 60px 20px; color: #888; }
      
      /* Wizard Animation */
      @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
      .wizard-step { animation: fadeIn 0.3s ease-out; }

  body
    nav.admin-nav
      .nav-brand
        i.fas.fa-shield-alt
        |  EPORIA ADMIN
      .nav-links
        a(href="/admin/dashboard" style="color:white; text-decoration:none; font-weight:700;") Dashboard
        button.btn-logout#btnLogout Logout

    .container
      .page-header
        h1 Artist Applications
        p Review and approve pending artist signup requests.

      .review-list#reviewList
        .empty-state
          i.fas.fa-spinner.fa-spin
          h2 Loading applications...

    //- APPROVAL WIZARD MODAL
    #approveWizard(style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:9999; align-items:center; justify-content:center; backdrop-filter: blur(8px);")
      .modal-content(style="background:#FFF; border-radius:16px; width:95%; max-width:450px; overflow:hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.5);")
        .modal-header(style="background:#88C9A1; padding:20px; color:white;")
          h2(style="margin:0; font-size:1.4rem;") Artist Approval Wizard
          p#wizardSub(style="margin:5px 0 0; font-size:0.85rem; opacity:0.9;") Step 1: Confirmation
        
        .modal-body(style="padding:30px;")
          //- Step 1: Confirmation
          #step1.wizard-step
            p(style="margin-bottom:15px; font-weight:700; color:#333;") You are about to approve:
            .artist-preview(style="background:#F5F5F5; padding:15px; border-radius:8px; border-left:4px solid #88C9A1; margin-bottom:20px;")
              h3#targetArtistName(style="margin:0; color:#5C4B3D;") Artist Name
              span#targetArtistHandle(style="color:#88C9A1; font-weight:700;") @handle
            p(style="font-size:0.9rem; color:#666;") This will grant them full access to the Eporia Artist Studio.
          
          //- Step 2: Credentials
          #step2.wizard-step(style="display:none;")
            div(style="margin-bottom:20px;")
              label(style="display:block; font-weight:800; font-size:0.8rem; text-transform:uppercase; color:#888; margin-bottom:8px;") Temporary Password *
              input#tempPassword(type="text" placeholder="e.g. Eporia2026!" style="width:100%; padding:12px; border:2px solid #EEE; border-radius:8px; font-size:1rem;")
              small(style="color:#AAA;") Min. 6 characters. You will email this to the artist.
            
            div
              label(style="display:block; font-weight:800; font-size:0.8rem; text-transform:uppercase; color:#888; margin-bottom:8px;") Internal Review Notes
              textarea#adminNotes(rows="3" placeholder="e.g. Verified via official Spotify link." style="width:100%; padding:12px; border:2px solid #EEE; border-radius:8px; font-family:inherit;")

          //- Step 3: Success & Copy Info
          #step3.wizard-step(style="display:none; text-align:center;")
            .success-icon(style="color:#88C9A1; font-size:3rem; margin-bottom:15px;")
                i.fas.fa-check-circle
            h3 Account Created!
            p(style="color:#666; margin-bottom:20px;") Copy the credentials below for your welcome email.
            .copy-box(style="background:#F5F5F5; padding:15px; border-radius:8px; text-align:left; font-family:monospace; font-size:0.9rem; margin-bottom:20px;")
                div(style="color:#888;") Email:
                div#finalEmail(style="color:#333; font-weight:bold; margin-bottom:10px;") 
                div(style="color:#888;") Password:
                div#finalPass(style="color:#333; font-weight:bold;") 
            button#btnCopy(onclick="copyToClipboard()" style="width:100%; padding:12px; background:#5C4B3D; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:700;") 
                i.fas.fa-copy(style="margin-right:8px;") 
                | Copy Credentials

        .modal-footer#wizardFooter(style="padding:20px; background:#F9F9F9; display:flex; justify-content:space-between; align-items:center;")
          button(onclick="closeWizard()" style="background:none; border:none; color:#999; cursor:pointer; font-weight:700;") Cancel
          div
            button#btnBack(onclick="moveWizard(-1)" style="display:none; padding:10px 20px; background:#EEE; border:none; border-radius:8px; margin-right:10px; cursor:pointer; font-weight:700;") Back
            button#btnNext(onclick="moveWizard(1)" style="padding:10px 25px; background:#5C4B3D; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:700;") Next
            button#btnFinal(onclick="executeApproval()" style="display:none; padding:10px 25px; background:#88C9A1; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:700;") Complete Approval

    script.
      let allReviews = [];
      let currentStep = 1;
      let activeArtistId = null;
      const token = sessionStorage.getItem('adminToken');
      if (!token) window.location.href = '/admin/login';

      async function loadReviews() {
        try {
          const response = await fetch('/admin/api/artists/pending?limit=50', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!response.ok) throw new Error('Auth Failed');
          const data = await response.json();
          allReviews = data.reviews || [];
          renderReviews(allReviews);
        } catch (e) { console.error(e); }
      }

      function renderReviews(reviews) {
        const container = document.getElementById('reviewList');
        container.innerHTML = '';
        if (reviews.length === 0) {
          container.innerHTML = '<div class="empty-state"><h2>No pending reviews</h2></div>';
          return;
        }
        reviews.forEach(review => {
          const item = document.createElement('div');
          item.className = 'review-item';
          item.innerHTML = `
            <div class="review-info">
              <h2>${review.artistName}</h2>
              <span class="handle">@${review.handle}</span>
              <div class="meta-item"><i class="fas fa-envelope"></i> ${review.contactEmail}</div>
              <div class="meta-item"><i class="fas fa-map-marker-alt"></i> ${review.location || 'Unknown'}</div>
            </div>
            <div class="review-actions" style="display:flex; flex-direction:column;">
              <button class="btn btn-approve" onclick="openWizard('${review.id}', '${review.artistName}', '${review.handle}')">Approve</button>
              <button class="btn btn-reject" onclick="rejectArtist('${review.id}')">Reject</button>
            </div>
          `;
          container.appendChild(item);
        });
      }

      // --- WIZARD CONTROLS ---
      window.openWizard = function(id, name, handle) {
        activeArtistId = id;
        document.getElementById('targetArtistName').innerText = name;
        document.getElementById('targetArtistHandle').innerText = '@' + handle;
        currentStep = 1;
        updateWizardUI();
        document.getElementById('approveWizard').style.display = 'flex';
      };

      window.closeWizard = function() {
        if (currentStep === 3) location.reload(); 
        document.getElementById('approveWizard').style.display = 'none';
        document.getElementById('tempPassword').value = '';
        document.getElementById('adminNotes').value = '';
      };

      window.moveWizard = function(dir) {
        currentStep += dir;
        updateWizardUI();
      };

      function updateWizardUI() {
        document.getElementById('step1').style.display = currentStep === 1 ? 'block' : 'none';
        document.getElementById('step2').style.display = currentStep === 2 ? 'block' : 'none';
        document.getElementById('step3').style.display = currentStep === 3 ? 'block' : 'none';
        
        document.getElementById('wizardSub').innerText = currentStep === 3 ? "Process Complete" : \`Step \${currentStep}: \${currentStep === 1 ? 'Confirmation' : 'Credentials'}\`;
        document.getElementById('btnBack').style.display = currentStep === 2 ? 'inline-block' : 'none';
        document.getElementById('btnNext').style.display = currentStep === 1 ? 'inline-block' : 'none';
        document.getElementById('btnFinal').style.display = currentStep === 2 ? 'inline-block' : 'none';
        
        if (currentStep === 3) {
            document.getElementById('wizardFooter').style.display = 'none';
            document.querySelector('.modal-header').style.background = '#5C4B3D';
        }
      }

      async function executeApproval() {
        const pass = document.getElementById('tempPassword').value.trim();
        const notes = document.getElementById('adminNotes').value.trim();
        if (pass.length < 6) return alert("Password too short! Use at least 6 characters.");

        const btn = document.getElementById('btnFinal');
        btn.innerText = "Creating Account...";
        btn.disabled = true;

        try {
          const res = await fetch(\`/admin/api/artists/\${activeArtistId}/approve\`, {
            method: 'POST',
            headers: { 'Authorization': \`Bearer \${token}\`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ tempPassword: pass, adminNotes: notes })
          });
          const result = await res.json();
          if (result.success) {
            document.getElementById('finalEmail').innerText = result.email;
            document.getElementById('finalPass').innerText = pass;
            currentStep = 3;
            updateWizardUI();
          } else {
            alert("Error: " + result.error);
            btn.innerText = "Complete Approval";
            btn.disabled = false;
          }
        } catch (e) { alert("Server error."); btn.disabled = false; }
      }

      window.copyToClipboard = function() {
          const email = document.getElementById('finalEmail').innerText;
          const pass = document.getElementById('finalPass').innerText;
          const text = \`Email: \${email}\\nPassword: \${pass}\`;
          
          navigator.clipboard.writeText(text).then(() => {
              const btn = document.getElementById('btnCopy');
              btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
              btn.style.background = '#88C9A1';
              setTimeout(() => {
                  btn.innerHTML = '<i class="fas fa-copy"></i> Copy Credentials';
                  btn.style.background = '#5C4B3D';
              }, 2000);
          });
      };

      window.rejectArtist = async function(id) {
        const reason = prompt("Enter rejection reason (Required):");
        if (!reason) return;
        const res = await fetch(\`/admin/api/artists/\${id}/reject\`, {
          method: 'POST',
          headers: { 'Authorization': \`Bearer \${token}\`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason })
        });
        if (res.ok) loadReviews();
      };

      document.getElementById('btnLogout').addEventListener('click', () => {
        sessionStorage.clear();
        window.location.href = '/admin/login';
      });

      loadReviews();