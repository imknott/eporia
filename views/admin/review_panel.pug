doctype html
html
  head
    title Artist Review Panel | Eporia Admin
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    link(rel='stylesheet', href='https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap')
    link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css")
    style.
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { 
        font-family: 'Nunito', sans-serif; 
        background: #F5F5F5; 
        padding: 20px;
      }
      /* Loading screen */
      .loading-screen {
        position: fixed;
        inset: 0;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .loading-content {
        text-align: center;
      }
      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #88C9A1;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .admin-header {
        background: linear-gradient(135deg, #5C4B3D 0%, #88C9A1 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
      }
      .admin-header h1 { margin-bottom: 10px; }
      .header-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }
      .btn-header {
        padding: 10px 20px;
        background: rgba(255,255,255,0.2);
        border: 2px solid white;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 700;
        font-family: 'Nunito', sans-serif;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
      }
      .btn-header:hover {
        background: white;
        color: #5C4B3D;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      }
      .stat-card h3 {
        font-size: 0.9rem;
        color: #888;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .stat-card .number {
        font-size: 2rem;
        font-weight: 800;
        color: #5C4B3D;
      }
      .review-list {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      }
      .review-item {
        padding: 25px;
        border-bottom: 1px solid #EEE;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 20px;
        align-items: start;
      }
      .review-item:last-child { border-bottom: none; }
      .review-info h2 {
        font-size: 1.2rem;
        margin-bottom: 5px;
        color: #333;
      }
      .review-info .handle {
        color: #88C9A1;
        font-weight: 700;
        margin-bottom: 10px;
      }
      .review-meta {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin: 10px 0;
      }
      .meta-item {
        font-size: 0.85rem;
        color: #666;
      }
      .meta-item i { color: #88C9A1; margin-right: 5px; }
      .links-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin: 15px 0;
      }
      .link-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: #F9F9F9;
        border-radius: 8px;
        font-size: 0.85rem;
        text-decoration: none;
        color: #333;
        transition: all 0.2s;
      }
      .link-item:hover {
        background: #E8F5E9;
        color: #2E7D32;
      }
      .link-item i { font-size: 1rem; }
      .priority-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .priority-high {
        background: #FFE5E5;
        color: #D32F2F;
      }
      .priority-normal {
        background: #E3F2FD;
        color: #1976D2;
      }
      .review-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        font-family: 'Nunito', sans-serif;
        font-size: 0.9rem;
        white-space: nowrap;
      }
      .btn-approve {
        background: #88C9A1;
        color: white;
      }
      .btn-approve:hover {
        background: #6FB085;
        transform: translateY(-2px);
      }
      .btn-reject {
        background: #FFF;
        color: #E74C3C;
        border: 2px solid #E74C3C;
      }
      .btn-reject:hover {
        background: #E74C3C;
        color: white;
      }
      .btn-view {
        background: #FFF;
        color: #5C4B3D;
        border: 2px solid #5C4B3D;
      }
      .btn-view:hover {
        background: #5C4B3D;
        color: white;
      }
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #888;
      }
      .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        color: #DDD;
      }

  body
    //- Loading screen
    #loadingScreen.loading-screen
      .loading-content
        .loading-spinner
        p Verifying access...

    //- Main content (hidden until verified)
    #mainContent(style="display:none")
      .admin-header
        h1 
          i.fas.fa-user-check(style="margin-right:10px")
          | Artist Review Panel
        p Review and approve artist applications
        .header-actions
          a.btn-header(href="/admin/dashboard")
            i.fas.fa-arrow-left(style="margin-right:5px")
            | Back to Dashboard
          button.btn-header#btnLogout
            i.fas.fa-sign-out-alt(style="margin-right:5px")
            | Logout

      .stats-grid
        .stat-card
          h3 Pending Reviews
          .number#pendingCount 0
        .stat-card
          h3 High Priority
          .number#highPriorityCount 0
        .stat-card
          h3 Approved Today
          .number#approvedCount 0
        .stat-card
          h3 Avg Review Time
          .number#avgTime --

      .review-list#reviewList
        .empty-state
          i.fas.fa-inbox
          h2 Loading applications...

    script.
      // FIXED: Correct API endpoints
      const API_BASE = '/admin/api';
      
      // Verify authentication
      async function verifyAuth() {
        const token = sessionStorage.getItem('adminToken');
        
        if (!token) {
          console.log('No token found - redirecting to login');
          window.location.href = '/admin/login';
          return false;
        }
        
        try {
          const response = await fetch('/admin/api/verify', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (!response.ok) {
            console.log('Token verification failed');
            sessionStorage.clear();
            window.location.href = '/admin/login';
            return false;
          }
          
          return true;
        } catch (error) {
          console.error('Auth verification error:', error);
          sessionStorage.clear();
          window.location.href = '/admin/login';
          return false;
        }
      }
      
      // Load pending reviews
      async function loadReviews() {
        try {
          const token = sessionStorage.getItem('adminToken');
          
          if (!token) {
            window.location.href = '/admin/login';
            return;
          }
          
          // FIXED: Correct endpoint path
          const response = await fetch(`${API_BASE}/artists/pending?limit=50`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
              sessionStorage.clear();
              window.location.href = '/admin/login';
              return;
            }
            throw new Error('Failed to load reviews');
          }
          
          const data = await response.json();
          
          if (data.reviews && data.reviews.length > 0) {
            renderReviews(data.reviews);
            updateStats(data.reviews);
          } else {
            document.getElementById('reviewList').innerHTML = `
              <div class="empty-state">
                <i class="fas fa-check-circle"></i>
                <h2>All caught up!</h2>
                <p>No pending artist applications to review.</p>
              </div>
            `;
          }
        } catch (error) {
          console.error('Load error:', error);
          document.getElementById('reviewList').innerHTML = `
            <div class="empty-state">
              <i class="fas fa-exclamation-circle"></i>
              <h2>Error loading reviews</h2>
              <p>${error.message}</p>
            </div>
          `;
        }
      }
      
      function renderReviews(reviews) {
        const container = document.getElementById('reviewList');
        container.innerHTML = '';
        
        reviews.forEach(review => {
          const item = document.createElement('div');
          item.className = 'review-item';
          
          const links = review.musicLinks || {};
          const linksHTML = Object.entries(links)
            .filter(([key, val]) => val)
            .map(([platform, url]) => {
              const icons = {
                spotify: 'fab fa-spotify',
                youtube: 'fab fa-youtube',
                apple: 'fab fa-apple',
                other: 'fas fa-music',
                instagram: 'fab fa-instagram',
                tiktok: 'fab fa-tiktok'
              };
              return `<a href="${url}" target="_blank" class="link-item">
                <i class="${icons[platform] || 'fas fa-link'}"></i> ${platform}
              </a>`;
            })
            .join('');
          
          item.innerHTML = `
            <div class="review-info">
              <h2>${review.artistName}</h2>
              <div class="handle">@${review.handle}</div>
              
              <div class="review-meta">
                <div class="meta-item">
                  <i class="fas fa-envelope"></i> ${review.contactEmail || 'No email'}
                </div>
                <div class="meta-item">
                  <i class="fas fa-${review.contactMethod === 'discord' ? 'headset' : 'envelope'}"></i> 
                  ${review.contactMethod || 'email'}
                </div>
                <div class="meta-item">
                  <i class="fas fa-${review.artistType === 'group' ? 'users' : 'user'}"></i> 
                  ${review.artistType || 'solo'} ${review.memberCount > 1 ? `(${review.memberCount} members)` : ''}
                </div>
                ${review.isrc ? `<div class="meta-item"><i class="fas fa-fingerprint"></i> ${review.isrc}</div>` : ''}
              </div>
              
              <span class="priority-badge priority-${review.priority}">
                ${review.priority} priority
              </span>
              
              ${linksHTML ? `<div class="links-grid" style="margin-top:15px">${linksHTML}</div>` : ''}
              
              <div style="margin-top:10px; font-size:0.85rem; color:#888">
                <i class="fas fa-clock"></i> 
                Applied ${new Date(review.submittedAt).toLocaleDateString()}
              </div>
            </div>
            
            <div class="review-actions">
              <button class="btn btn-approve" onclick="approveArtist('${review.id}')">
                <i class="fas fa-check"></i> Approve
              </button>
              <button class="btn btn-reject" onclick="rejectArtist('${review.id}')">
                <i class="fas fa-times"></i> Reject
              </button>
            </div>
          `;
          
          container.appendChild(item);
        });
      }
      
      function updateStats(reviews) {
        document.getElementById('pendingCount').innerText = reviews.length;
        const highPriority = reviews.filter(r => r.priority === 'high').length;
        document.getElementById('highPriorityCount').innerText = highPriority;
      }
      
      // Load stats from API
      async function loadStats() {
        try {
          const token = sessionStorage.getItem('adminToken');
          
          const response = await fetch('/admin/api/stats', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (response.ok) {
            const data = await response.json();
            document.getElementById('approvedCount').innerText = data.approvedTodayCount || 0;
            document.getElementById('avgTime').innerText = data.avgReviewTime ? `${data.avgReviewTime}d` : '--';
          }
        } catch (error) {
          console.error('Stats error:', error);
        }
      }
      
      async function approveArtist(artistId) {
        if (!confirm('Approve this artist? They will gain dashboard access.')) return;
        
        const notes = prompt('Add approval notes (optional):');
        
        try {
          const token = sessionStorage.getItem('adminToken');
          
          // FIXED: Correct endpoint path
          const response = await fetch(`${API_BASE}/artists/${artistId}/approve`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ adminNotes: notes })
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert('Artist approved!');
            loadReviews(); // Reload list
            loadStats(); // Refresh stats
          } else {
            alert('Error: ' + result.error);
          }
        } catch (error) {
          console.error('Approve error:', error);
          alert('Failed to approve artist');
        }
      }
      
      async function rejectArtist(artistId) {
        const reason = prompt('Rejection reason (required):');
        if (!reason || !reason.trim()) return;
        
        try {
          const token = sessionStorage.getItem('adminToken');
          
          // FIXED: Correct endpoint path
          const response = await fetch(`${API_BASE}/artists/${artistId}/reject`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ reason })
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert('Artist rejected');
            loadReviews();
            loadStats();
          } else {
            alert('Error: ' + result.error);
          }
        } catch (error) {
          console.error('Reject error:', error);
          alert('Failed to reject artist');
        }
      }
      
      // Logout
      document.getElementById('btnLogout')?.addEventListener('click', () => {
        sessionStorage.clear();
        window.location.href = '/admin/login';
      });
      
      // Initialize page
      async function init() {
        const isAuthed = await verifyAuth();
        
        if (isAuthed) {
          // Hide loading, show content
          document.getElementById('loadingScreen').style.display = 'none';
          document.getElementById('mainContent').style.display = 'block';
          
          // Load data
          await loadReviews();
          await loadStats();
        }
      }
      
      // Start
      init();
