doctype html
html
  head
    title Artist Review Panel | Eporia Admin
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    link(rel='stylesheet', href='https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap')
    link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css")
    style.
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { 
        font-family: 'Nunito', sans-serif;
        background: #F5F5F5; 
        padding: 20px;
      }
      .admin-header {
        background: linear-gradient(135deg, #5C4B3D 0%, #88C9A1 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
      }
      .header-actions { display: flex; gap: 10px; margin-top: 15px; }
      .btn-header {
        padding: 10px 20px;
        background: rgba(255,255,255,0.2);
        border: 2px solid white;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 700;
        text-decoration: none;
      }
      .btn-header:hover { background: white; color: #5C4B3D; }
      .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
      .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
      .stat-card .number { font-size: 2rem; font-weight: 800; color: #5C4B3D; }
      .review-list { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
      .review-item { padding: 25px; border-bottom: 1px solid #EEE; display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: start; }
      .handle { color: #88C9A1; font-weight: 700; }
      .review-actions { display: flex; flex-direction: column; gap: 10px; }
      .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; }
      .btn-approve { background: #88C9A1; color: white; }
      .btn-reject { background: #FFF; color: #E74C3C; border: 2px solid #E74C3C; }
      .btn-reject:hover { background: #E74C3C; color: white; }
      .wizard-step { animation: fadeIn 0.3s ease-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

  body
    #loadingScreen(style="position:fixed; inset:0; background:white; display:flex; align-items:center; justify-content:center; z-index:9999;")
      div(style="text-align:center;")
        div(style="width:50px; height:50px; border:4px solid #f3f3f3; border-top:4px solid #88C9A1; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 20px;")
        p Verifying access...

    #mainContent(style="display:none")
      .admin-header
        h1 
          i.fas.fa-user-check(style="margin-right:10px")
          | Artist Review Panel
        p Review and approve artist applications
        .header-actions
          a.btn-header(href="/admin/dashboard") Back to Dashboard
          button.btn-header#btnLogout Logout

      .stats-grid
        .stat-card: h3 Pending: div.number#pendingCount 0
        .stat-card: h3 Priority: div.number#highPriorityCount 0
        .stat-card: h3 Approved: div.number#approvedCount 0
        .stat-card: h3 Avg Time: div.number#avgTime --

      .review-list#reviewList
        .empty-state(style="text-align:center; padding:60px; color:#888;")
          i.fas.fa-inbox(style="font-size:3rem; margin-bottom:15px;")
          h2 Loading applications...

    //- THE APPROVAL WIZARD MODAL
    #approveWizard(style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:9999; align-items:center; justify-content:center; backdrop-filter: blur(8px);")
      .modal-content(style="background:#FFF; border-radius:16px; width:95%; max-width:450px; overflow:hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.5);")
        .modal-header(style="background:#88C9A1; padding:20px; color:white;")
          h2(style="margin:0;") Artist Approval Wizard
          p#wizardSub(style="margin:5px 0 0; opacity:0.9;") Step 1: Confirmation
        
        .modal-body(style="padding:30px;")
          #step1.wizard-step
            p(style="margin-bottom:15px; font-weight:700;") Confirming approval for:
            div(style="background:#F5F5F5; padding:15px; border-radius:8px; border-left:4px solid #88C9A1;")
              h3#targetArtistName Artist Name
              span#targetArtistHandle.handle @handle
          
          #step2.wizard-step(style="display:none;")
            div(style="margin-bottom:20px;")
              label(style="display:block; font-weight:800; margin-bottom:8px;") Temporary Password *
              input#tempPassword(type="text" placeholder="e.g. WelcomeToEporia!" style="width:100%; padding:12px; border:2px solid #EEE; border-radius:8px;")
            div
              label(style="display:block; font-weight:800; margin-bottom:8px;") Review Notes
              textarea#adminNotes(rows="2" style="width:100%; padding:12px; border:2px solid #EEE; border-radius:8px;")

          #step3.wizard-step(style="display:none; text-align:center;")
            i.fas.fa-check-circle(style="color:#88C9A1; font-size:3rem; margin-bottom:15px;")
            h3 Account Created!
            .copy-box(style="background:#F5F5F5; padding:15px; border-radius:8px; text-align:left; margin:20px 0;")
                div(style="color:#888;") Email:
                div#finalEmail(style="font-weight:bold; margin-bottom:10px;") 
                div(style="color:#888;") Password:
                div#finalPass(style="font-weight:bold;") 
            button#btnCopy(onclick="copyToClipboard()" style="width:100%; padding:12px; background:#5C4B3D; color:white; border-radius:8px; cursor:pointer; font-weight:700;") Copy Credentials

        .modal-footer#wizardFooter(style="padding:20px; background:#F9F9F9; display:flex; justify-content:space-between;")
          button(onclick="closeWizard()" style="border:none; background:none; color:#999; cursor:pointer;") Cancel
          div
            button#btnBack(onclick="moveWizard(-1)" style="display:none; padding:10px; margin-right:10px;") Back
            button#btnNext(onclick="moveWizard(1)" style="padding:10px 20px; background:#5C4B3D; color:white; border-radius:8px;") Next
            button#btnFinal(onclick="executeApproval()" style="display:none; padding:10px 20px; background:#88C9A1; color:white; border-radius:8px;") Complete Approval

    script.
      let activeArtistId = null, currentStep = 1;
      const token = sessionStorage.getItem('adminToken');
      if (!token) window.location.href = '/admin/login';

      async function loadReviews() {
        try {
          const res = await fetch('/admin/api/artists/pending?limit=50', { headers: { 'Authorization': `Bearer ${token}` } });
          const data = await res.json();
          renderReviews(data.reviews || []);
        } catch (e) { console.error(e); }
      }

      function renderReviews(reviews) {
        const container = document.getElementById('reviewList');
        container.innerHTML = reviews.length ? '' : '<div class="empty-state"><h2>All clear!</h2></div>';
        reviews.forEach(r => {
          const item = document.createElement('div');
          item.className = 'review-item';
          item.innerHTML = `<div class="review-info"><h2>${r.artistName}</h2><div class="handle">@${r.handle}</div></div>
            <div class="review-actions">
              <button class="btn btn-approve" onclick="openWizard('${r.id}', '${r.artistName}', '${r.handle}')">Approve</button>
              <button class="btn btn-reject" onclick="rejectArtist('${r.id}')">Reject</button>
            </div>`;
          container.appendChild(item);
        });
      }

      window.openWizard = (id, name, handle) => {
        activeArtistId = id;
        document.getElementById('targetArtistName').innerText = name;
        document.getElementById('targetArtistHandle').innerText = '@' + handle;
        currentStep = 1; updateWizardUI();
        document.getElementById('approveWizard').style.display = 'flex';
      };

      window.closeWizard = () => {
        if (currentStep === 3) location.reload();
        document.getElementById('approveWizard').style.display = 'none';
      };

      window.moveWizard = (dir) => { currentStep += dir; updateWizardUI(); };

      function updateWizardUI() {
        document.getElementById('step1').style.display = currentStep === 1 ? 'block' : 'none';
        document.getElementById('step2').style.display = currentStep === 2 ? 'block' : 'none';
        document.getElementById('step3').style.display = currentStep === 3 ? 'block' : 'none';
        document.getElementById('btnBack').style.display = currentStep === 2 ? 'inline-block' : 'none';
        document.getElementById('btnNext').style.display = currentStep === 1 ? 'inline-block' : 'none';
        document.getElementById('btnFinal').style.display = currentStep === 2 ? 'inline-block' : 'none';
        if (currentStep === 3) document.getElementById('wizardFooter').style.display = 'none';
      }

      async function executeApproval() {
        const pass = document.getElementById('tempPassword').value.trim();
        if (pass.length < 6) return alert("Password too short!");
        const btn = document.getElementById('btnFinal');
        btn.innerText = "Processing..."; btn.disabled = true;
        try {
          const res = await fetch(`/admin/api/artists/${activeArtistId}/approve`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ tempPassword: pass, adminNotes: document.getElementById('adminNotes').value })
          });
          const result = await res.json();
          if (result.success) {
            document.getElementById('finalEmail').innerText = result.email;
            document.getElementById('finalPass').innerText = pass;
            currentStep = 3; updateWizardUI();
          } else { alert(result.error); btn.innerText = "Complete"; btn.disabled = false; }
        } catch (e) { alert("Server error"); btn.disabled = false; }
      }

      window.copyToClipboard = () => {
        const text = `Email: ${document.getElementById('finalEmail').innerText}\nPassword: ${document.getElementById('finalPass').innerText}`;
        navigator.clipboard.writeText(text).then(() => {
          document.getElementById('btnCopy').innerText = "Copied!";
          setTimeout(() => document.getElementById('btnCopy').innerText = "Copy Credentials", 2000);
        });
      };

      window.rejectArtist = async (id) => {
        const reason = prompt("Enter rejection reason:");
        if (!reason) return;
        await fetch(`/admin/api/artists/${id}/reject`, {
          method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason })
        });
        loadReviews();
      };

      document.getElementById('btnLogout').onclick = () => { sessionStorage.clear(); window.location.href = '/admin/login'; };
      
      async function init() {
        const auth = await fetch('/admin/api/verify', { headers: { 'Authorization': `Bearer ${token}` } });
        if (auth.ok) {
          document.getElementById('loadingScreen').style.display = 'none';
          document.getElementById('mainContent').style.display = 'block';
          loadReviews();
        } else { window.location.href = '/admin/login'; }
      }
      init();