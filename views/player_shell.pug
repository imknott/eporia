//- views/player_shell.pug
doctype html
html
  head
    title= title || 'Eporia Player'
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    
    //- Font Awesome Icons
    link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css")
    
    //- Cropper.js for image editing
    link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css")
    
    //- ============================================
    //-  MODULAR CSS IMPORTS
    //-  Single main.css imports everything in order
    //- ============================================
    
    //- Option 1: Use main.css (imports everything automatically)
    link(rel='stylesheet' href='/stylesheets/main.css')
    
    //- Option 2: Manual imports (if main.css doesn't exist yet)
    //- Uncomment these if you haven't created main.css yet
    //-
    //- //- Core Foundation
    //- link(rel='stylesheet' href='/stylesheets/core/variables.css')
    //- link(rel='stylesheet' href='/stylesheets/core/reset.css')
    //- link(rel='stylesheet' href='/stylesheets/core/typography.css')
    //-
    //- //- Layout
    //- link(rel='stylesheet' href='/stylesheets/layout/sidebar-left.css')
    //- link(rel='stylesheet' href='/stylesheets/layout/main-wrapper.css')
    //-
    //- //- Components
    //- link(rel='stylesheet' href='/stylesheets/components/buttons.css')
    //- link(rel='stylesheet' href='/stylesheets/components/forms.css')
    //- link(rel='stylesheet' href='/stylesheets/components/cards.css')
    //- link(rel='stylesheet' href='/stylesheets/components/player-full.css')
    //- link(rel='stylesheet' href='/stylesheets/components/player-mini.css')
    //- link(rel='stylesheet' href='/stylesheets/components/search.css')
    //- link(rel='stylesheet' href='/stylesheets/components/profile-dropdown.css')
    //- link(rel='stylesheet' href='/stylesheets/components/notifications.css')
    //- link(rel='stylesheet' href='/stylesheets/components/modals.css')
    //-
    //- //- Pages
    //- link(rel='stylesheet' href='/stylesheets/pages/dashboard.css')
    //- link(rel='stylesheet' href='/stylesheets/pages/settings.css')
    //- link(rel='stylesheet' href='/stylesheets/pages/wallet.css')
    //- link(rel='stylesheet' href='/stylesheets/pages/profile.css')
    //- link(rel='stylesheet' href='/stylesheets/pages/workbench.css')
    //-
    //- //- Utilities
    //- link(rel='stylesheet' href='/stylesheets/utilities/animations.css')
    //- link(rel='stylesheet' href='/stylesheets/utilities/scrollbars.css')
    //-
    //- //- Responsive & Themes
    //- link(rel='stylesheet' href='/stylesheets/layout/responsive.css')
    //- link(rel='stylesheet' href='/stylesheets/core/themes.css')
    
    //- ============================================
    //-  LEGACY CSS (Keep until migration complete)
    //- ============================================
    //- Uncomment these if you need fallback during migration
    //-
    //- link(rel='stylesheet' href='/stylesheets/playerStyle.css.backup')
    //- link(rel='stylesheet' href='/stylesheets/rightSideBar.css.backup')
    //- link(rel='stylesheet' href='/stylesheets/profile.css.backup')
    
    //- ============================================
    //-  PAGE-SPECIFIC CSS (Keep these)
    //- ============================================
    link(rel='stylesheet' href='/stylesheets/pages/artistProfile.css')
    link(rel='stylesheet' href='/stylesheets/pages/workbench.css')
    link(rel='stylesheet' href='/stylesheets/crate_view.css')
    link(href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css', rel='stylesheet')
    link(href='/stylesheets/city-soundscape-map.css', rel='stylesheet')

  body
    //- [MOBILE BLOCKER] Shown only on small screens via CSS
    #mobile-block-msg
      i.fas.fa-desktop
      h2 Desktop Only
      p We're building a dedicated mobile app for the best experience. For now, please use Eporia on your computer.

    //- 1. LEFT SIDEBAR (Navigation)
    include partials/left_sidebar

    //- 2. MAIN CONTENT WRAPPER
    .main-wrapper
      block content

    //- 3. RIGHT SIDEBAR (Player & Search)
    include partials/right_sidebar

        //- ==========================================
    //- TIP ARTIST MODAL
    //- ==========================================
    #tipModal.modal-overlay(style="display: none;")
      .modal-container.tip-modal
        .modal-header
          h2 Tip 
            span#tipArtistName Artist
          button.modal-close(onclick="window.ui.closeTipModal()")
            i.fas.fa-times

        .modal-body
          //- Balance Display
          .tip-balance-card
            .balance-label Your Available Balance
            .balance-display
              span.currency $
              span#tipWalletBalance 0.00

          //- Quick Select Buttons
          .tip-options-grid
            button.btn-tip-option(onclick="window.ui.selectTipAmount(1)") $1
            button.btn-tip-option(onclick="window.ui.selectTipAmount(5)") $5
            button.btn-tip-option(onclick="window.ui.selectTipAmount(10)") $10
            button.btn-tip-option(onclick="window.ui.selectTipAmount('max')") Max

          //- Custom Input
          .tip-custom-input-group
            label(for="customTipInput") Custom Amount
            .input-wrapper
              span.input-prefix $
              input#customTipInput(
                type="number" 
                placeholder="0.00" 
                min="0.01" 
                step="0.01"
                oninput="window.ui.validateTipInput()"
              )

          //- Action Buttons
          .modal-actions
            button.btn-secondary(onclick="window.ui.closeTipModal()") Cancel
            button#confirmTipBtn.btn-primary(
              onclick="window.ui.submitTip()" 
              disabled
            ) Send Tip

    //- ============================================
    //-  CRITICAL UI FUNCTIONS
    //-  Defined as plain script — NOT a module.
    //-  Runs immediately, independent of the entire
    //-  module import chain. If enhancedPlayer.js or
    //-  any import fails, these still work.
    //- ============================================
    script.
      // Profile menu toggle
      function toggleProfileMenu() {
        var d = document.getElementById('profileDropdown');
        if (d) d.classList.toggle('active');
      }

      // Player size toggle — delegates to module once loaded
      function togglePlayerSize() {
        if (window.ui && window.ui.togglePlayerSize) {
          window.ui.togglePlayerSize();
        } else {
          var sidebar = document.getElementById('rightSidebar');
          if (sidebar) sidebar.classList.toggle('minimized');
        }
      }

      // Play / send command — delegates to module once loaded
      function togglePlay() {
        if (window.ui) window.ui.togglePlay?.();
      }
      function sendCmd(cmd) {
        if (window.ui) window.ui.sendCmd?.(cmd);
      }

      // Search filter toggle — delegates to SocialController
      function toggleSearchFilter() {
        if (window.ui && window.ui.socialController) {
          window.ui.socialController.toggleSearchFilter?.();
        } else {
          var m = document.getElementById('searchFilterMenu');
          if (m) m.classList.toggle('active');
        }
      }
      function setSearchMode(mode) {
        if (window.ui && window.ui.socialController) {
          window.ui.socialController.setSearchMode?.(mode);
        }
      }

      // Navigation — delegates to appRouter once loaded,
      // falls back to hard redirect so it always works
      function navigateTo(url) {
        if (window._navigateTo) {
          window._navigateTo(url);
        } else {
          window.location.href = url;
        }
      }


      document.addEventListener('click', function(e) {
        var menu = document.getElementById('profileDropdown');
        var trigger = document.querySelector('.profile-trigger');
        if (menu && menu.classList.contains('active')) {
          if (!menu.contains(e.target) && (!trigger || !trigger.contains(e.target))) {
            menu.classList.remove('active');
          }
        }
        var searchMenu = document.getElementById('searchFilterMenu');
        if (searchMenu && searchMenu.classList.contains('active')) {
          var searchContainer = document.querySelector('.search-container');
          if (!searchContainer || !searchContainer.contains(e.target)) {
            searchMenu.classList.remove('active');
          }
        }
      });


    script.
      window.R2_PUBLIC_URL = '#{process.env.R2_PUBLIC_URL || "https://cdn.eporiamusic.com"}';
    
    //- Main application entry point (includes city map via uiController)
    //- SPA router — loads appRouter which registers window._navigateTo
    //- Must be separate from enhancedPlayer so it loads independently
    script(type="module" src="/javascripts/appRouter.js")

    //- Main application entry point
    script(type="module" src="/javascripts/enhancedPlayer.js")
