doctype html
html(lang="en")
  head
    title Join the Collective | Eporia
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    link(rel='stylesheet', href='https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap')
    link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css")
    link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css")
    link(rel='stylesheet', href='/stylesheets/layout.css')
    link(rel='stylesheet', href='/stylesheets/userSignup.css')
    link(rel='stylesheet', href='/stylesheets/auth.css')

  body
    //- Auth Check Spinner
    #authCheckSpinner.auth-checking
      .auth-checking-spinner

    //- CLEAN NAV
    nav.simple-nav
      .nav-left
        a.back-link(href="/") 
          i.fas.fa-arrow-left
          span Back Home
      
      .nav-center
        span.logo-text Eporia
        
      .nav-right
        a.btn-login-nav(href="/members/signin") 
          span.login-text-muted Already a member?
          span.login-text-bold Log In

    //- Wrapper
    .signup-wrapper
      //- PROGRESS BAR
      .progress-container
        .progress-track
          .progress-fill#progressFill
        .steps-indicator
          span.step.active(data-step="1") 1
          span.step(data-step="2") 2
          span.step(data-step="3") 3
          span.step(data-step="4") 4

      form#userSignupForm
        
        //- STEP 1: Identity (Unchanged)
        .form-step.active(data-step="1")
          .step-header
            h1 Claim Your Identity
            p Create your account to start your journey.

          .profile-upload-section
            input#profileFileInput(type="file" accept="image/*" style="display:none")
            .profile-preview-wrapper#triggerProfileUpload
              img#profilePreview(src="/images/40889.jpg" alt="Profile Pic")
              .camera-icon
                i.fas.fa-camera
            p.upload-hint Tap to upload image

          #authOptions
            .input-group
              label.label Handle (Username)
              .handle-wrapper
                span.at-symbol @
                input#handleInput(type="text" name="handle" placeholder="AudioPhileDave" required)
                span#handleStatus.status-icon
              p.hint-text This is your unique ID in the community.

            .email-auth-fields#emailFields
              .input-group
                label.label Email Address
                .input-wrapper
                  input#emailInput(type="email" name="email" placeholder="name@example.com" required)
                  span#emailStatus.status-icon
                p#emailHint.hint-text(style="display:none; color:#e74c3c; font-size:0.8rem; margin-top:5px")

              .grid-2
                .input-group
                  label.label Password
                  .input-wrapper
                    input#passwordInput(type="password" name="password" placeholder="Create password" required)
                    i.fas.fa-eye.password-toggle(onclick="togglePassword('passwordInput', this)")
                
                .input-group
                  label.label Confirm Password
                  .input-wrapper
                    input#confirmPasswordInput(type="password" placeholder="Re-enter password" required disabled)
                    span#matchStatus.status-icon

              .password-requirements#passReqs
                p.req-title Must contain:
                ul
                  li#req-len(class="req-item") 
                    i.far.fa-circle
                    span 8+ Characters
                  li#req-num(class="req-item") 
                    i.far.fa-circle
                    span 1 Number
                  li#req-sym(class="req-item") 
                    i.far.fa-circle
                    span 1 Special Char (!@#$)
                    
            .legal-consent-container(style="margin: 25px 0; background: #FFF; padding: 20px; border-radius: 12px; border: 1px solid #EEE; box-shadow: 0 4px 15px rgba(0,0,0,0.03);")
              p(style="font-size:0.85rem; font-weight:700; color:#444; margin-bottom:15px; text-transform:uppercase; letter-spacing:0.5px") <i class="fas fa-file-contract"></i> Required Agreements
              .legal-checklist(style="display:flex; flex-direction:column; gap:10px; margin-bottom:20px")
                .legal-item(id="item-terms" onclick="openModal('termsModal')" style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:#F9F9F9; border-radius:8px; cursor:pointer; transition:all 0.2s")
                  div(style="display:flex; align-items:center; gap:10px")
                    i.fas.fa-gavel(style="color:#888")
                    span(style="font-size:0.9rem; font-weight:600") Terms of Service
                  i.status-icon.far.fa-circle(style="color:#ccc")
                .legal-item(id="item-privacy" onclick="openModal('privacyModal')" style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:#F9F9F9; border-radius:8px; cursor:pointer; transition:all 0.2s")
                  div(style="display:flex; align-items:center; gap:10px")
                    i.fas.fa-user-shield(style="color:#888")
                    span(style="font-size:0.9rem; font-weight:600") Privacy Policy
                  i.status-icon.far.fa-circle(style="color:#ccc")
                .legal-item(id="item-cookie" onclick="openModal('cookieModal')" style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:#F9F9F9; border-radius:8px; cursor:pointer; transition:all 0.2s")
                  div(style="display:flex; align-items:center; gap:10px")
                    i.fas.fa-cookie-bite(style="color:#888")
                    span(style="font-size:0.9rem; font-weight:600") Cookie Policy
                  i.status-icon.far.fa-circle(style="color:#ccc")
              label.checkbox-card(id="mainLegalLabel" style="width:100%; border:none; padding:0; background:transparent; opacity:0.5; pointer-events:none; transition:opacity 0.3s")
                input#legalCheck(type="checkbox" disabled)
                span(style="font-size:0.85rem; font-weight:600; color:#888") I have read and agree to all agreements above.

          button.btn-next#step1NextBtn(type="button" onclick="attemptNextStep(1)" disabled style="opacity:0.5; cursor:not-allowed") 
            | Next: Your Taste 
            i.fas.fa-arrow-right

        //- STEP 2: TASTE (Unchanged)
        .form-step(data-step="2")
          .step-header
            h1 Curate Your Feed
            p Tell us what you love, and who you want to see here.

          .input-group(style="margin-bottom: 30px;")
            label.label Your Local Scene (City)
            .location-wrapper(style="position:relative")
              i.fas.fa-map-marker-alt(style="position:absolute; left:15px; top:50%; transform:translateY(-50%); color:#88C9A1; z-index:2")
              input#locationInput(type="text" placeholder="e.g. San Diego, Berlin, Tokyo" style="padding-left: 40px;" autocomplete="off")
              .suggestions-dropdown
            p.hint-text We use this to connect you with local artists and events.

          .input-group
            label.label What is your primary vibe?
            select#primaryGenreSelect(class="styled-select" onchange="handlePrimaryGenreChange()")
              option(value="" disabled selected) Select a Genre...
          
          .input-group#subgenreSection(style="display:none; animation:fadeIn 0.5s")
            label.label Dive deeper (Optional)
            .chip-grid#subgenreGrid
            p.hint-text Select up to 3 subgenres to refine your recommendations.

          .input-group(style="margin-top:30px")
            label.label Artist Wishlist
            textarea#artistRequestInput(rows="3" placeholder="Which independent artists should we recruit? e.g. Neon Echoes, The Midnight..." style="resize:none")
            p.hint-text We prioritize recruiting artists requested by beta members.

          .btn-row
            button.btn-back(type="button" onclick="prevStep(2)") Back
            button.btn-next(type="button" onclick="attemptNextStep(2)") 
              | Next: Experience 
              i.fas.fa-arrow-right

        //- STEP 3: EXPERIENCE & IMPACT
        .form-step(data-step="3")
          .step-header
            h1 Experience & Impact
            p Define your sound and how you support the scene.

          //- 1. ANTHEM SELECTION
          .anthem-block
             label.label(style="text-align:center; margin-bottom:15px") Define Your Anthem
             p.hint-text(style="text-align:center; margin-bottom:20px") Search our database for the song that defines you.
             .anthem-search-container
               i.fas.fa-search.search-icon
               input#anthemSearch(type="text" placeholder="Search Eporia library..." autocomplete="off")
               .search-results#searchResults

             .selected-anthem-card#selectedAnthem(style="display:none")
               img#anthemCover(src="" alt="Cover")
               .anthem-info
                 h4#anthemTitle Track Title
                 p#anthemArtist Artist Name
               button.remove-anthem(type="button" onclick="clearAnthem()")
                 i.fas.fa-times

          //- [NEW] 2. ALLOCATION MODE
          .input-group(style="margin-top:35px")
            label.label Choose Your Impact Style
            p.hint-text How do you want to distribute your subscription funds?
            
            .allocation-grid(style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:15px")
                //- Option A: MANUAL
                label.alloc-card
                    input(type="radio" name="allocationMode" value="manual" checked onchange="handleAllocChange(this)")
                    .alloc-content
                        .alloc-icon: i.fas.fa-hand-holding-usd
                        .alloc-title Manual Allocation
                        .alloc-desc Get credits monthly. You actively tip and support artists.
                        .alloc-fee 20% Platform Fee
                        .alloc-credits(id="manualCreditsPreview") ~649 Credits/mo

                //- Option B: AUTO
                label.alloc-card
                    input(type="radio" name="allocationMode" value="auto" onchange="handleAllocChange(this)")
                    .alloc-content
                        .alloc-icon: i.fas.fa-magic
                        .alloc-title Auto-Flow
                        .alloc-desc Stream normally. We distribute 70% to your artists automatically.
                        .alloc-fee 30% Platform Fee
                        .alloc-credits No manual work.

          //- 3. SETTINGS
          .settings-config-card(style="background:white; border:2px solid #EEE; border-radius:15px; padding:20px; margin-top:30px")
             h4(style="margin:0 0 15px 0; color:#5C4B3D; font-size:1rem; border-bottom:1px solid #eee; padding-bottom:10px") <i class="fas fa-sliders-h"></i> Privacy
             
             .setting-row(style="display:flex; justify-content:space-between; align-items:center")
                div
                   div(style="font-weight:800; font-size:0.9rem") Enable Taste Match
                   div(style="font-size:0.8rem; color:#888") Allow others to see music compatibility.
                label.toggle-switch
                   input#tasteMatchToggle(type="checkbox" checked)
                   span.slider.round

          .btn-row
            button.btn-back(type="button" onclick="prevStep(3)") Back
            button.btn-next(type="button" onclick="attemptNextStep(3)") 
              | Next: Membership 
              i.fas.fa-arrow-right

        //- STEP 4: MEMBERSHIP & PAYMENT
        .form-step(data-step="4")
          .step-header
            h2 Select Your Membership
            p.step-desc Choose how you want to support the underground.
          
          //- [NEW] Billing Toggle
          .billing-toggle-wrapper
            span.billing-label(class="active") Monthly
            label.billing-switch
              input#billingIntervalToggle(type="checkbox" onchange="toggleBillingInterval()")
              span.billing-slider.round
            span.billing-label Yearly 
              span.save-badge SAVE 10%
          
          .plans-grid
            
            //- PLAN 1: DISCOVERY
            label.plan-card
              input(type="radio" name="plan" value="discovery")
              .plan-content
                .plan-header(style="font-size:1.2rem; font-weight:800; color:#5C4B3D") Discovery
                .price(style="font-size:2.5rem; font-weight:900; color:#88C9A1; margin:10px 0") $7.99
                p(style="font-size:0.9rem; color:#888; margin-bottom:20px; line-height:1.4") Full access to all streaming features and crates.
                ul.plan-features
                  li <i class="fas fa-check" style="color:#88C9A1"></i> Ad-free Listening
                  li <i class="fas fa-check" style="color:#88C9A1"></i> High Quality Audio
                  li <i class="fas fa-check" style="color:#88C9A1"></i> Direct Artist Allocation

            //- PLAN 2: SUPPORTER (Middle - Selected by Default)
            label.plan-card
              input(type="radio" name="plan" value="supporter" checked)
              .plan-content(style="border-color:#88C9A1; position:relative; overflow:hidden")
                //- Badge
                .most-popular-badge(style="position:absolute; top:0; left:0; width:100%; background:#88C9A1; color:white; font-size:0.75rem; font-weight:800; padding:6px 0; text-transform:uppercase; letter-spacing:1px") Most Popular
                
                .plan-header(style="font-size:1.2rem; font-weight:800; color:#5C4B3D; margin-top:25px") Supporter
                .price(style="font-size:2.5rem; font-weight:900; color:#88C9A1; margin:10px 0") $12.99
                p(style="font-size:0.9rem; color:#888; margin-bottom:20px; line-height:1.4") For those who want to give more to the creators.
                ul.plan-features
                  li <i class="fas fa-check" style="color:#88C9A1"></i> <strong>Higher Artist Payouts</strong>
                  li <i class="fas fa-check" style="color:#88C9A1"></i> Supporter Badge
                  li <i class="fas fa-check" style="color:#88C9A1"></i> Early Access to Features

            //- PLAN 3: CHAMPION
            label.plan-card
              input(type="radio" name="plan" value="champion")
              .plan-content
                .plan-header(style="font-size:1.2rem; font-weight:800; color:#5C4B3D") Champion
                .price(style="font-size:2.5rem; font-weight:900; color:#88C9A1; margin:10px 0") $24.99
                p(style="font-size:0.9rem; color:#888; margin-bottom:20px; line-height:1.4") Maximum impact for the ecosystem.
                ul.plan-features
                  li <i class="fas fa-check" style="color:#88C9A1"></i> <strong>Maximum Allocation</strong>
                  li <i class="fas fa-check" style="color:#88C9A1"></i> Golden "Champion" Badge
                  li <i class="fas fa-check" style="color:#88C9A1"></i> Priority Feature Requests

          //- Centered Buttons for the Wide Layout
          .btn-row(style="max-width: 600px; margin: 40px auto 0 auto;")
            button.btn-back(type="button" onclick="prevStep(4)") Back
            
            //- Final Submit Button
            .next-actions(style="display:flex; gap:10px; flex:2")
                button.btn-submit#btnPayment(type="button" onclick="submitBetaSignup()" style="flex:2; background:#5C4B3D") 
                  span#finishBtnText Proceed to Payment
                  i.fas.fa-credit-card


      //- TERMS MODAL
      #termsModal.modal-overlay
        .crop-modal.legal-modal-size
          .modal-header
            h2 Terms of Service
            p.subtitle Loading from Eporia Legal...
          //- IFRAME CONTAINER
          .iframe-container
            iframe#termsFrame.legal-frame(src="" data-src="/legal/terms")
          .modal-actions
            button.btn-next(onclick="acceptLegal('terms')" style="width:100%") I Have Read & Accept

      //- PRIVACY MODAL
      #privacyModal.modal-overlay
        .crop-modal.legal-modal-size
          .modal-header
            h2 Privacy Policy
            p.subtitle Loading from Eporia Legal...
          .iframe-container
            iframe#privacyFrame.legal-frame(src="" data-src="/legal/privacy")
          .modal-actions
            button.btn-next(onclick="acceptLegal('privacy')" style="width:100%") I Have Read & Accept

      //- COOKIE MODAL
      #cookieModal.modal-overlay
        .crop-modal.legal-modal-size
          .modal-header
            h2 Cookie Policy
            p.subtitle Loading from Eporia Legal...
          .iframe-container
            iframe#cookieFrame.legal-frame(src="" data-src="/legal/cookie")
          .modal-actions
            button.btn-next(onclick="acceptLegal('cookie')" style="width:100%") I Have Read & Accept

    script(src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js")
    script(type="module" src="/javascripts/userSignup.js")