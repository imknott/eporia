doctype html
html(lang="en")
  head
    title Join the Collective | Eporia
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    //- Cyberpunk Electronic Fonts
    link(rel='stylesheet', href='https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;800;900&family=Share+Tech+Mono&display=swap')
    link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css")
    link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css")
    //- Cyberpunk Theme Stylesheets
    link(rel='stylesheet', href='/stylesheets/userSignup_cyberpunk.css')

  body

    .animated-background#animBg
    //- Auth Check Spinner
    #authCheckSpinner.auth-checking
      .auth-checking-spinner

    //- CLEAN NAV
    nav.simple-nav
      .nav-left
        a.back-link(href="/") 
          i.fas.fa-arrow-left
          span Back Home
      
      .nav-center
        span.logo-text Eporia
        
      .nav-right
        a.btn-login-nav(href="/members/signin") 
          span.login-text-muted Already a member?
          span.login-text-bold Log In

    //- Wrapper
    .signup-wrapper
      //- PROGRESS BAR
      .progress-container
        .progress-track
          .progress-fill#progressFill
        .steps-indicator
          span.step.active(data-step="1") 1
          span.step(data-step="2") 2
          span.step(data-step="3") 3
          span.step(data-step="4") 4

      form#userSignupForm
        
        //- STEP 1: Identity (Unchanged)
        .form-step.active(data-step="1")
          .step-header
            h1 Claim Your Identity
            p Create your account to start your journey.

          .profile-upload-section
            input#profileFileInput(type="file" accept="image/*" style="display:none")
            .profile-preview-wrapper#triggerProfileUpload
              img#profilePreview(src="/images/40889.jpg" alt="Profile Pic")
              .camera-icon
                i.fas.fa-camera
            p.upload-hint Tap to upload image

          #authOptions
            .input-group
              label.label Handle (Username)
              .handle-wrapper
                span.at-symbol @
                input#handleInput(type="text" name="handle" placeholder="AudioPhileDave" required)
                span#handleStatus.status-icon
              p.hint-text This is your unique ID in the community.

            .email-auth-fields#emailFields
              .input-group
                label.label Email Address
                .input-wrapper
                  input#emailInput(type="email" name="email" placeholder="name@example.com" required)
                  span#emailStatus.status-icon
                p#emailHint.hint-text(style="display:none; color:#e74c3c; font-size:0.8rem; margin-top:5px")

              .grid-2
                .input-group
                  label.label Password
                  .input-wrapper
                    input#passwordInput(type="password" name="password" placeholder="Create password" required)
                    i.fas.fa-eye.password-toggle(onclick="togglePassword('passwordInput', this)")
                
                .input-group
                  label.label Confirm Password
                  .input-wrapper
                    input#confirmPasswordInput(type="password" placeholder="Re-enter password" required disabled)
                    span#matchStatus.status-icon

              .password-requirements#passReqs
                p.req-title Must contain:
                ul
                  li#req-len(class="req-item") 
                    i.far.fa-circle
                    span 8+ Characters
                  li#req-num(class="req-item") 
                    i.far.fa-circle
                    span 1 Number
                  li#req-sym(class="req-item") 
                    i.far.fa-circle
                    span 1 Special Char (!@#$)
                    
            .legal-consent-container
              p <i class="fas fa-file-contract"></i> Required Agreements
              .legal-checklist
                .legal-item(id="item-terms" onclick="openModal('termsModal')")
                  div
                    i.fas.fa-gavel
                    span Terms of Service
                  i.status-icon.far.fa-circle
                .legal-item(id="item-privacy" onclick="openModal('privacyModal')")
                  div
                    i.fas.fa-user-shield
                    span Privacy Policy
                  i.status-icon.far.fa-circle
                .legal-item(id="item-cookie" onclick="openModal('cookieModal')")
                  div
                    i.fas.fa-cookie-bite
                    span Cookie Policy
                  i.status-icon.far.fa-circle
              label.checkbox-card(id="mainLegalLabel")
                input#legalCheck(type="checkbox" disabled)
                span I have read and agree to all agreements above.

          button.btn-next#step1NextBtn(type="button" onclick="attemptNextStep(1)" disabled) 
            | Next: Your Taste 
            i.fas.fa-arrow-right

        //- STEP 2: TASTE (Unchanged)
        .form-step(data-step="2")
          .step-header
            h1 Curate Your Feed
            p Tell us what you love, and who you want to see here.

          .input-group.location-group
            label.label Your Local Scene (City)
            .location-wrapper
              i.fas.fa-map-marker-alt.location-icon
              input#locationInput(type="text" placeholder="e.g. San Diego, Berlin, Tokyo" autocomplete="off")
              .suggestions-dropdown
            p.hint-text We use this to connect you with local artists and events.

          .input-group
            label.label What is your primary vibe?
            select#primaryGenreSelect(class="styled-select")
              option(value="" disabled selected) Select a Genre...
          
          .input-group#subgenreSection.hidden-section
            label.label Dive deeper (Optional)
            .chip-grid#subgenreGrid
            p.hint-text Select up to 3 subgenres to refine your recommendations.

          .input-group.artist-wishlist-group
            label.label Artist Wishlist
            textarea#artistRequestInput(rows="3" placeholder="Which independent artists should we recruit? e.g. Neon Echoes, The Midnight...")
            p.hint-text We prioritize recruiting artists requested by beta members.

          .btn-row
            button.btn-back(type="button" onclick="prevStep(2)") Back
            button.btn-next(type="button" onclick="attemptNextStep(2)") 
              | Next: Experience 
              i.fas.fa-arrow-right

        //- STEP 3: EXPERIENCE & IMPACT
        .form-step(data-step="3")
          .step-header
            h1 Experience & Impact
            p Define your sound and how you support the scene.

          //- 1. ANTHEM SELECTION
          .anthem-block
             label.label(style="text-align:center; margin-bottom:15px") Define Your Anthem
             p.hint-text(style="text-align:center; margin-bottom:20px") Search our database for the song that defines you.
             .anthem-search-container
               i.fas.fa-search.search-icon
               input#anthemSearch(type="text" placeholder="Search Eporia library..." autocomplete="off")
               .search-results#searchResults

             .selected-anthem-card#selectedAnthem(style="display:none")
               img#anthemCover(src="" alt="Cover")
               .anthem-info
                 h4#anthemTitle Track Title
                 p#anthemArtist Artist Name
               button.remove-anthem(type="button" onclick="clearAnthem()")
                 i.fas.fa-times

          //- [NEW] 2. ALLOCATION MODE
          .input-group(style="margin-top:35px")
            label.label Choose Your Impact Style
            p.hint-text How do you want to distribute your subscription funds?
            
            .allocation-grid(style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:15px")
                //- Option A: HYBRID (Default)
                label.alloc-card
                    input(type="radio" name="allocationMode" value="hybrid" checked onchange="handleAllocChange(this)")
                    .alloc-content
                        .alloc-icon: i.fas.fa-magic
                        .alloc-title Hybrid Flow
                        .alloc-badge.recommended RECOMMENDED
                        .alloc-desc 60% of your membership is automatically distributed to artists we know you love — based on your listening. You keep 20% in your wallet to tip anytime a track hits different.
                        .alloc-breakdown
                            span.breakdown-item
                                i.fas.fa-robot
                                | 60% → Auto-allocated to your favorites
                            span.breakdown-item
                                i.fas.fa-wallet
                                | 20% → Your wallet to tip freely

                //- Option B: MANUAL
                label.alloc-card
                    input(type="radio" name="allocationMode" value="manual" onchange="handleAllocChange(this)")
                    .alloc-content
                        .alloc-icon: i.fas.fa-hand-holding-usd
                        .alloc-title Manual Control
                        .alloc-desc You decide everything. 80% of your membership goes directly into your wallet — allocate it to any artist, anytime you want.
                        .alloc-breakdown
                            span.breakdown-item
                                i.fas.fa-wallet
                                | 80% → Your wallet (you allocate)
                            span.breakdown-item
                                i.fas.fa-building
                                | 20% → Platform

          //- 3. SETTINGS
          .settings-config-card
             h4 <i class="fas fa-sliders-h"></i> Privacy
             
             .setting-row
                div
                   div Enable Taste Match
                   div Allow others to see music compatibility.
                label.toggle-switch
                   input#tasteMatchToggle(type="checkbox" checked)
                   span.slider.round

          .btn-row
            button.btn-back(type="button" onclick="prevStep(3)") Back
            button.btn-next(type="button" onclick="attemptNextStep(3)") 
              | Next: Membership 
              i.fas.fa-arrow-right

        //- STEP 4: MEMBERSHIP & PAYMENT
        .form-step(data-step="4")
          .step-header
            h2 Select Your Membership
            p.step-desc Choose how you want to support the underground.
          
          //- [NEW] Billing Toggle
          .billing-toggle-wrapper
            span.billing-label(class="active") Monthly
            label.billing-switch
              input#billingIntervalToggle(type="checkbox" onchange="toggleBillingInterval()")
              span.billing-slider.round
            span.billing-label Yearly 
              span.save-badge SAVE 10%
          
          .plans-grid
            
            //- PLAN 1: DISCOVERY
            label.plan-card
              input(type="radio" name="plan" value="discovery")
              .plan-content
                .plan-header Discovery
                .price $7.99
                p Full access to all streaming features and crates.
                ul.plan-features
                  li <i class="fas fa-check"></i> Ad-free Listening
                  li <i class="fas fa-check"></i> High Quality Audio (320kbps)
                  li <i class="fas fa-check"></i> Direct Artist Allocation
                  li <i class="fas fa-check"></i> Hybrid &amp; Manual Modes
                  li <i class="fas fa-check"></i> Taste Match Scores

            //- PLAN 2: SUPPORTER (Middle - Selected by Default)
            label.plan-card.popular-plan
              input(type="radio" name="plan" value="supporter" checked)
              .plan-content
                //- Badge
                .most-popular-badge Most Popular
                
                .plan-header Supporter
                .price $12.99
                p For those who want to give more to the creators.
                ul.plan-features
                  li <i class="fas fa-check"></i> <strong>Higher Artist Payouts</strong>
                  li <i class="fas fa-check"></i> Supporter Badge
                  li <i class="fas fa-check"></i> Early Access to Features
                  li.plan-feature-highlight <i class="fas fa-book-open"></i> <strong>Annual Digital Zine</strong> — A personalized year-in-review: your top artists, taste match scores by city, and artist picks tailored to you
                  li <i class="fas fa-check"></i> Priority Queue for Artist Requests

            //- PLAN 3: CHAMPION
            label.plan-card.champion-plan
              input(type="radio" name="plan" value="champion")
              .plan-content
                .champion-badge
                  i.fas.fa-crown
                  | CHAMPION
                .plan-header Champion
                .price $24.99
                p Maximum impact for the ecosystem.
                ul.plan-features
                  li <i class="fas fa-check"></i> <strong>Maximum Artist Allocation</strong>
                  li <i class="fas fa-check"></i> Golden "Champion" Badge
                  li <i class="fas fa-check"></i> Priority Feature Requests
                  li.plan-feature-highlight <i class="fas fa-book"></i> <strong>Annual Physical Zine</strong> — A real printed, personalized year-in-review book shipped to you: your favorite artists, taste match scores, and curated artist spotlights
                  li.plan-feature-highlight <i class="fas fa-infinity"></i> <strong>Lossless Audio</strong> — Full lossless FLAC streaming &amp; master track quality where available
                  li <i class="fas fa-check"></i> Exclusive Champion-only events &amp; drops

          //- Centered Buttons for the Wide Layout
          .btn-row.payment-actions
            button.btn-back(type="button" onclick="prevStep(4)") Back
            
            //- Final Submit Button
            .next-actions
                button.btn-submit#btnPayment(type="button" onclick="submitBetaSignup()") 
                  span#finishBtnText Proceed to Payment
                  i.fas.fa-credit-card




      //- CROP MODAL
      #cropModal.modal-overlay
        .crop-modal.crop-modal-size
          .modal-header
            h2 Adjust Your Photo
            p.subtitle Drag to reposition, scroll to zoom
          .crop-container
            img#imageToCrop(alt="Image to crop")
          .modal-actions
            button.btn-back(onclick="cancelCrop()") Cancel
            button.btn-next(onclick="saveCrop()") Save Photo

      //- TERMS MODAL
      #termsModal.modal-overlay
        .crop-modal.legal-modal-size
          .modal-header
            h2 Terms of Service
            p.subtitle Loading from Eporia Legal...
          //- IFRAME CONTAINER
          .iframe-container
            iframe#termsFrame.legal-frame(src="" data-src="/legal/terms")
          .modal-actions
            button.btn-next.btn-accept(onclick="acceptLegal('terms')") I Have Read & Accept

      //- PRIVACY MODAL
      #privacyModal.modal-overlay
        .crop-modal.legal-modal-size
          .modal-header
            h2 Privacy Policy
            p.subtitle Loading from Eporia Legal...
          .iframe-container
            iframe#privacyFrame.legal-frame(src="" data-src="/legal/privacy")
          .modal-actions
            button.btn-next.btn-accept(onclick="acceptLegal('privacy')") I Have Read & Accept

      //- COOKIE MODAL
      #cookieModal.modal-overlay
        .crop-modal.legal-modal-size
          .modal-header
            h2 Cookie Policy
            p.subtitle Loading from Eporia Legal...
          .iframe-container
            iframe#cookieFrame.legal-frame(src="" data-src="/legal/cookie")
          .modal-actions
            button.btn-next.btn-accept(onclick="acceptLegal('cookie')") I Have Read & Accept

    script(src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js")
    script(type="module" src="/javascripts/userSignup.js")